<!DOCTYPE html>
<html lang="en">
<head>
    <script src="js/master-fix.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Customer Insights & Problem Solver | AI Smart Hub</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   <script src="js/master-fix.js"></script>
    <script src="js/fix-all-html.js"></script>  <!-- ADD THIS LINE -->
    <meta charset="UTF-8" />
  <style>
    :root {
      --primary: #d4af37;
      --primary-hover: #b8962e;
      --dark: #1a1a1a;
      --dark-accent: #2d2d2d;
      --light: #f8f9fa;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #f59e0b;
      --info: #3b82f6;
      --border-color: #e0e0e0;
      --shadow: 0 8px 25px rgba(0,0,0,0.06);
      --card-radius: 16px;
      --transition: 0.3s ease;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', sans-serif;
      background: #f8fafc;
      color: var(--dark);
      line-height: 1.6;
    }

    nav {
      background: white;
      padding: 16px 0;
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 12px rgba(0,0,0,0.04);
    }

    .nav-container {
      max-width: 1280px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 24px;
    }

    .nav-logo {
      font-weight: 700;
      font-size: 1.35rem;
      color: var(--dark);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-links {
      display: flex;
      gap: 28px;
      align-items: center;
    }

    .nav-links a {
      text-decoration: none;
      color: #555;
      font-size: 0.95rem;
      font-weight: 500;
      transition: var(--transition);
    }

    .nav-links a:hover,
    .active-nav {
      color: var(--primary);
    }

    .back-btn {
      background: var(--dark);
      color: white !important;
      padding: 10px 22px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .hero {
      background: white;
      padding: 80px 24px;
      text-align: center;
      border-bottom: 1px solid var(--border-color);
    }

    .hero h1 {
      font-size: 2.6rem;
      margin-bottom: 16px;
      font-weight: 800;
      letter-spacing: -1px;
    }

    .hero p {
      color: #555;
      max-width: 720px;
      margin: 0 auto;
      font-size: 1.1rem;
    }

    .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 40px 24px 100px;
    }

    .section-header {
      margin: 50px 0 24px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .section-header h2 {
      font-size: 1.55rem;
      font-weight: 700;
      margin: 0;
    }

    .section-line {
      flex: 1;
      height: 1px;
      background: #e0e0e0;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
      gap: 28px;
    }

    .tool-card {
      background: white;
      border-radius: var(--card-radius);
      padding: 32px;
      border: 1px solid var(--border-color);
      transition: var(--transition);
      box-shadow: var(--shadow);
    }

    .tool-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 16px 40px rgba(0,0,0,0.1);
    }

    .wide-card {
      grid-column: 1 / -1;
    }

    .icon-box {
      width: 52px;
      height: 52px;
      background: #fff9e6;
      color: var(--primary);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: 20px;
    }

    h3 {
      font-size: 1.28rem;
      font-weight: 700;
      margin-bottom: 12px;
    }

    .tool-description {
      color: #666;
      font-size: 0.94rem;
      line-height: 1.5;
      margin-bottom: 24px;
    }

    .locked-card {
      position: relative;
    }

    .lock-overlay {
      position: absolute;
      inset: 0;
      background: rgba(255,255,255,0.94);
      backdrop-filter: blur(12px);
      z-index: 10;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 40px;
      border-radius: var(--card-radius);
    }

    .upgrade-btn {
      background: var(--dark);
      color: white;
      border: none;
      padding: 14px 32px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      transition: var(--transition);
    }

    .upgrade-btn:hover {
      background: var(--primary);
    }

    .input-group {
      margin-bottom: 20px;
      display: flex;
      gap: 12px;
      align-items: flex-end;
      flex-wrap: wrap;
    }

    label {
      display: block;
      font-size: 0.84rem;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--dark);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    input, textarea, select {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 1rem;
      transition: var(--transition);
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(212,175,55,0.15);
    }

    .btn-save, .search-btn, .btn-secondary, .btn-primary {
      background: var(--primary);
      color: white;
      border: none;
      padding: 14px 24px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      transition: var(--transition);
    }

    .btn-save:hover, .search-btn:hover, .btn-secondary:hover, .btn-primary:hover {
      background: var(--primary-hover);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: #6c757d;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
    }
    
    .btn-primary {
      background: var(--primary);
    }
    
    .btn-danger {
      background: var(--danger);
    }
    
    .btn-danger:hover {
      background: #b02a37;
    }
    
    .btn-info {
      background: var(--info);
    }
    
    .btn-info:hover {
      background: #2563eb;
    }

    .search-btn {
      padding: 12px 24px;
      white-space: nowrap;
    }

    .data-table-container {
      overflow-x: auto;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      margin-top: 16px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 14px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    th {
      background: #f9fafb;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 0.82rem;
      color: #555;
      cursor: pointer;
    }
    
    th:hover {
      background: #f1f3f4;
    }

    .status-badge {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.82rem;
      font-weight: 700;
    }

    .badge-high { background: #fee2e2; color: #b91c1c; }
    .badge-med  { background: #fef3c7; color: #b45309; }
    .badge-low  { background: #d1fae5; color: #047857; }
    .badge-info { background: #dbeafe; color: #1e40af; }
    .badge-success { background: #d1fae5; color: #047857; }
    .badge-warning { background: #fef3c7; color: #b45309; }

    .ai-chat {
      height: 340px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 16px;
      background: white;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
    }

    .message {
      margin: 10px 0;
      padding: 10px 14px;
      border-radius: 12px;
      max-width: 84%;
      line-height: 1.45;
      font-size: 0.96rem;
    }

    .message.user {
      background: var(--primary);
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }

    .message.bot {
      background: #f8fafc;
      border-bottom-left-radius: 4px;
    }

    .ai-typing {
      color: #888;
      font-style: italic;
      padding: 12px 0;
      text-align: center;
    }

    .live-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--success);
      font-weight: 600;
      font-size: 0.9rem;
      margin-left: 12px;
    }

    .pulse-dot {
      width: 9px;
      height: 9px;
      background: var(--success);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(40,167,69,0.6); }
      70% { box-shadow: 0 0 0 12px rgba(40,167,69,0); }
      100% { box-shadow: 0 0 0 0 rgba(40,167,69,0); }
    }

    footer {
      text-align: center;
      padding: 60px 20px;
      color: #777;
      font-size: 0.92rem;
      border-top: 1px solid var(--border-color);
      background: white;
    }

    .widget-trigger-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 14px 32px;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      margin: 20px auto;
      display: block;
      transition: all 0.3s;
    }

    .widget-trigger-btn:hover {
      background: var(--primary-hover);
      transform: translateY(-2px);
    }

    .hidden { display: none !important; }
    
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .error-message {
      background: #fee2e2;
      color: #b91c1c;
      padding: 12px;
      border-radius: 8px;
      margin: 10px 0;
    }
    
    .success-message {
      background: #d1fae5;
      color: #047857;
      padding: 12px;
      border-radius: 8px;
      margin: 10px 0;
    }
    
    /* Toggle Switch */
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }
    
    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .slider {
      background-color: var(--primary);
    }
    
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    
    /* Problem Tabs */
    .problem-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .problem-tab {
      padding: 10px 20px;
      background: #f8f9fa;
      border: 1px solid var(--border-color);
      border-radius: 30px;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
    }
    
    .problem-tab:hover {
      background: var(--primary);
      color: white;
    }
    
    .problem-tab.active {
      background: var(--primary);
      color: white;
    }
    
    /* Metric Cards */
    .metric-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    
    .metric-card {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }
    
    .metric-value {
      font-size: 2rem;
      font-weight: 800;
      color: var(--primary);
    }
    
    .metric-label {
      font-size: 0.9rem;
      color: #666;
    }
    
    /* Email Broadcast */
    .email-broadcast {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px;
      border-radius: var(--card-radius);
      margin: 40px 0;
    }
    
    .email-broadcast h3 {
      color: white;
      font-size: 1.8rem;
    }
    
    .email-stats {
      display: flex;
      gap: 30px;
      margin: 20px 0;
    }
    
    .email-stat {
      text-align: center;
    }
    
    .email-stat-number {
      font-size: 2rem;
      font-weight: 800;
    }
    
    .email-stat-label {
      font-size: 0.9rem;
      opacity: 0.9;
    }
    
    .template-preview {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      color: var(--dark);
    }
    
    /* Response Templates */
    .response-templates {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .template-item {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .template-item:hover {
      background: var(--primary);
      color: white;
    }
  </style>
</head>
<body>

<nav>
  <div class="nav-container">
    <a href="index.html" class="nav-logo"><span>‚ú®</span> AI Smart Hub</a>
    <div class="nav-links">
      <a href="index.html">Dashboard</a>
      <a href="smart-tools.html">AI Tools</a>
      <a href="customer-insights.html" class="active-nav">Customer Insights</a>
      <a href="team.html">Team</a>
      <a href="index.html" class="back-btn">Exit Center</a>
    </div>
  </div>
</nav>

<div class="hero">
  <h1>Customer Insights & Problem Solver</h1>
  <p>Real-time visibility into customer issues ‚Äî powered by Cloudflare AI (fast summaries, fixes, churn prediction & alerts).</p>
</div>

<div class="container">

  <!-- Plan Lock Overlay -->
  <div id="plan-lock" class="tool-card locked-card">
    <div class="lock-overlay">
      <h3>Pro or Agency Plan Required</h3>
      <p>Upgrade to unlock real-time customer intelligence, AI problem solving, predictive analytics, and team tools.</p>
      <button class="upgrade-btn" onclick="window.location.href='pricing.html'">Upgrade Now</button>
    </div>
  </div>

  <div id="main-content" class="hidden">

    <!-- ===== CUSTOMER SEARCH SECTION ===== -->
    <div class="section-header">
      <h2>üîç Customer Search & Filters</h2>
      <div class="section-line"></div>
    </div>

    <div class="tool-card">
      <div class="input-group">
        <div style="flex:2;">
          <label for="customer-search">Search Customers</label>
          <input type="text" id="customer-search" placeholder="Type name or email to filter..." oninput="searchCustomers()" />
        </div>
        <div style="flex:1;">
          <label for="sentiment-filter">Filter by Sentiment</label>
          <select id="sentiment-filter" onchange="applyFilters()">
            <option value="all">All Sentiments</option>
            <option value="positive">Positive Only</option>
            <option value="negative">Negative Only</option>
            <option value="neutral">Neutral Only</option>
          </select>
        </div>
        <button class="search-btn" onclick="applyFilters()" style="align-self:flex-end;">Apply Filters</button>
      </div>
      <div class="input-group">
        <div style="flex:1;">
          <label for="date-from">Date From</label>
          <input type="date" id="date-from" onchange="applyFilters()">
        </div>
        <div style="flex:1;">
          <label for="date-to">Date To</label>
          <input type="date" id="date-to" onchange="applyFilters()">
        </div>
        <div style="flex:1;">
          <label for="problem-filter">Filter by Problem</label>
          <select id="problem-filter" onchange="applyFilters()">
            <option value="all">All Problems</option>
            <option value="delivery">Delivery Issues</option>
            <option value="quality">Product Quality</option>
            <option value="pricing">Pricing Concerns</option>
            <option value="support">Customer Support</option>
            <option value="refund">Refund Requests</option>
            <option value="ux">UX/Confusion</option>
          </select>
        </div>
        <button class="btn-secondary" onclick="resetFilters()" style="align-self:flex-end;">Reset Filters</button>
      </div>
    </div>

    <!-- ===== CUSTOMER LIST SECTION ===== -->
    <div class="section-header">
      <h2>üìã Customer List & Issues <span class="live-indicator"><span class="pulse-dot"></span>LIVE</span></h2>
      <div class="section-line"></div>
    </div>

    <div class="wide-card tool-card">
      <div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
          <h3>All Customers & Detected Problems</h3>
          <div style="display: flex; gap: 15px;">
            <span id="customer-count" style="background: var(--primary); color: white; padding: 5px 15px; border-radius: 20px; font-weight: 600;"></span>
            <span id="problem-count" style="background: var(--info); color: white; padding: 5px 15px; border-radius: 20px; font-weight: 600;"></span>
          </div>
        </div>
        <p class="tool-description">Real-time overview ‚Äî sorted by highest churn risk first. Click column headers to sort.</p>
        <div class="data-table-container">
          <table class="customer-table">
            <thead>
              <tr>
                <th onclick="sortTable('name')">Name üìä</th>
                <th onclick="sortTable('email')">Email üìä</th>
                <th onclick="sortTable('messages')">Messages / Sentiment üìä</th>
                <th onclick="sortTable('risk')">Churn Risk üìä</th>
                <th>Problem Tags</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="customer-table-body">
              <tr><td colspan="6" style="text-align:center;padding:60px;color:#777;">Loading real-time customer data...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ===== AI WIDGET PREVIEW ===== -->
    <div class="section-header">
      <h2>ü§ñ Business AI Widget (Live Preview)</h2>
      <div class="section-line"></div>
    </div>

    <div class="wide-card tool-card" style="text-align:center;">
      <p class="tool-description">Click below to preview how your customers see the AI widget ‚Äî it knows your full business, all leads, detected problems, churn risks, and more.</p>
      <button class="widget-trigger-btn" onclick="showAIWidget()">Show AI Widget Now</button>
      <div id="widget-preview-area" style="min-height:400px; margin-top:24px; border:1px dashed #ccc; border-radius:12px; background:#fafafa; position:relative;"></div>
    </div>

    <!-- ===== AI PROBLEM SOLVER ===== -->
    <div class="section-header">
      <h2>ü§ñ AI Problem Solver Assistant</h2>
      <div class="section-line"></div>
    </div>

    <div class="wide-card tool-card">
      <div>
        <h3>Your Cloudflare AI Consultant <span style="color:var(--primary);font-size:0.9rem;">(Agency Exclusive)</span></h3>
        <p class="tool-description">Ask anything about your customers ‚Äî powered by fast Cloudflare AI.</p>
        <div class="ai-chat" id="ai-chat-messages">
          <div style="text-align:center;padding:80px 20px;color:#888;">Start typing to chat with your AI...</div>
        </div>
        <div style="display:flex;gap:12px;">
          <input type="text" id="ai-input" placeholder="e.g. Summarize John Doe's issues or 'Show me all customers with high churn risk'" style="flex:1;" onkeypress="if(event.key==='Enter') sendAiMessage()" />
          <button class="btn-save" onclick="sendAiMessage()" style="width:auto;padding:0 32px;">Ask AI</button>
        </div>
        <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
          <button class="btn-secondary" onclick="sendAiMessage('Show top 5 customers with highest churn risk')">üî¥ High Risk</button>
          <button class="btn-secondary" onclick="sendAiMessage('Summarize all negative feedback from last 7 days')">üìä Weekly Summary</button>
          <button class="btn-secondary" onclick="sendAiMessage('Suggest improvements based on customer complaints')">üí° Improvements</button>
          <button class="btn-secondary" onclick="sendAiMessage('What are the top 3 recurring problems?')">‚ö†Ô∏è Top Problems</button>
        </div>
      </div>
    </div>

    <!-- ===== CUSTOMER PROBLEM-SOLVING SUITE (NEW) ===== -->
    <div class="section-header">
      <h2>üõ°Ô∏è Customer Problem-Solving Suite <span class="live-indicator"><span class="pulse-dot"></span>AI POWERED</span></h2>
      <div class="section-line"></div>
    </div>

    <!-- Problem Categories Tabs -->
    <div class="problem-tabs">
      <div class="problem-tab active" onclick="switchProblemTab('all')">All Problems</div>
      <div class="problem-tab" onclick="switchProblemTab('delivery')">üöö Delivery</div>
      <div class="problem-tab" onclick="switchProblemTab('quality')">üè∑Ô∏è Quality</div>
      <div class="problem-tab" onclick="switchProblemTab('pricing')">üí∞ Pricing</div>
      <div class="problem-tab" onclick="switchProblemTab('support')">ü§ù Support</div>
      <div class="problem-tab" onclick="switchProblemTab('refund')">‚Ü©Ô∏è Refunds</div>
      <div class="problem-tab" onclick="switchProblemTab('ux')">üì± UX Issues</div>
    </div>

    <!-- Problem Metrics Dashboard -->
    <div class="metric-grid">
      <div class="metric-card">
        <div class="metric-value" id="total-problems">0</div>
        <div class="metric-label">Total Problems</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="critical-problems">0</div>
        <div class="metric-label">Critical Issues</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="avg-resolution">0h</div>
        <div class="metric-label">Avg Resolution</div>
      </div>
      <div class="metric-card">
        <div class="metric-value" id="satisfaction-rate">0%</div>
        <div class="metric-label">Satisfaction</div>
      </div>
    </div>

    <!-- Problem Resolution Tools Grid -->
    <div class="grid" style="margin-top: 30px;">
      
      <!-- Tool 1: AI Problem Classifier -->
      <div class="tool-card">
        <div class="icon-box">üîç</div>
        <h3>AI Problem Classifier</h3>
        <p class="tool-description">Automatically categorizes customer issues with 98% accuracy. Detects root causes in real-time.</p>
        <div style="background:#f8f9fa; padding:15px; border-radius:10px; margin:15px 0;">
          <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <span>Delivery Issues</span>
            <span id="stat-delivery" style="font-weight:700;">0</span>
          </div>
          <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <span>Quality Concerns</span>
            <span id="stat-quality" style="font-weight:700;">0</span>
          </div>
          <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <span>Pricing Questions</span>
            <span id="stat-pricing" style="font-weight:700;">0</span>
          </div>
          <div style="display:flex; justify-content:space-between;">
            <span>Support Requests</span>
            <span id="stat-support" style="font-weight:700;">0</span>
          </div>
        </div>
        <button class="btn-secondary" onclick="analyzeProblemTrends()" style="width:100%;">Analyze Trends</button>
      </div>

      <!-- Tool 2: Smart Response Generator -->
      <div class="tool-card">
        <div class="icon-box">‚úçÔ∏è</div>
        <h3>Smart Response Generator</h3>
        <p class="tool-description">Generates personalized, empathetic responses based on problem type and customer history.</p>
        <select id="response-problem-type" style="margin-bottom:10px;">
          <option value="delivery">Delivery Delay</option>
          <option value="quality">Product Quality</option>
          <option value="refund">Refund Request</option>
          <option value="support">Technical Support</option>
          <option value="complaint">General Complaint</option>
        </select>
        <textarea id="response-context" placeholder="Additional context (optional)..." rows="2"></textarea>
        <button class="btn-save" onclick="generateSmartResponse()" style="margin-top:10px; width:100%;">Generate Response</button>
        <div id="response-output" style="margin-top:15px; padding:15px; background:#f8f9fa; border-radius:8px; display:none;"></div>
      </div>

      <!-- Tool 3: Churn Prevention AI -->
      <div class="tool-card">
        <div class="icon-box">‚ö†Ô∏è</div>
        <h3>Churn Prevention AI</h3>
        <p class="tool-description">Predicts which customers are about to churn and suggests intervention strategies.</p>
        <div style="margin:15px 0;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <span>High Risk Customers:</span>
            <span id="high-risk-count" style="font-weight:700; color:var(--danger);">0</span>
          </div>
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <span>Medium Risk:</span>
            <span id="medium-risk-count" style="font-weight:700; color:var(--warning);">0</span>
          </div>
        </div>
        <button class="btn-danger" onclick="showAtRiskCustomers()" style="width:100%;">View At-Risk Customers</button>
      </div>

      <!-- Tool 4: Sentiment Timeline -->
      <div class="tool-card">
        <div class="icon-box">üìà</div>
        <h3>Sentiment Timeline</h3>
        <p class="tool-description">Track how customer sentiment evolves over time and spot emerging issues.</p>
        <canvas id="sentiment-timeline" height="150"></canvas>
        <div style="margin-top:15px;">
          <button class="btn-secondary" onclick="refreshSentimentTimeline()" style="width:100%;">Refresh Data</button>
        </div>
      </div>

      <!-- Tool 5: Auto-Ticket Creator -->
      <div class="tool-card">
        <div class="icon-box">üé´</div>
        <h3>Auto-Ticket Creator</h3>
        <p class="tool-description">Automatically creates support tickets for critical issues and assigns to the right team.</p>
        <div style="margin:15px 0;">
          <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
            <span>Auto-create tickets for:</span>
            <select id="ticket-threshold" style="width:100px;">
              <option value="70">70% risk</option>
              <option value="80">80% risk</option>
              <option value="90">90% risk</option>
            </select>
          </div>
          <div style="display:flex; align-items:center; gap:10px;">
            <span>Auto-assign to:</span>
            <select id="ticket-assignee">
              <option value="support">Support Team</option>
              <option value="technical">Technical Team</option>
              <option value="billing">Billing Team</option>
            </select>
          </div>
        </div>
        <button class="btn-save" onclick="saveTicketSettings()">Save Settings</button>
        <div style="margin-top:15px; padding:10px; background:#f8f9fa; border-radius:8px;">
          <span>Open Tickets: <strong id="open-tickets">0</strong></span>
        </div>
      </div>

      <!-- Tool 6: Knowledge Base Suggester -->
      <div class="tool-card">
        <div class="icon-box">üìö</div>
        <h3>Knowledge Base Suggester</h3>
        <p class="tool-description">Identifies knowledge gaps and suggests articles to prevent future issues.</p>
        <div id="knowledge-suggestions" style="margin:15px 0;">
          <div style="padding:10px; background:#f8f9fa; border-radius:8px; margin-bottom:5px;">
            <strong>üìù "Delivery times"</strong> - 23 mentions
          </div>
          <div style="padding:10px; background:#f8f9fa; border-radius:8px; margin-bottom:5px;">
            <strong>üìù "Return policy"</strong> - 15 mentions
          </div>
          <div style="padding:10px; background:#f8f9fa; border-radius:8px;">
            <strong>üìù "Sizing guide"</strong> - 12 mentions
          </div>
        </div>
        <button class="btn-secondary" onclick="refreshKnowledgeSuggestions()">Refresh Suggestions</button>
      </div>

      <!-- Tool 7: Problem Heatmap -->
      <div class="tool-card">
        <div class="icon-box">üî•</div>
        <h3>Problem Heatmap</h3>
        <p class="tool-description">Visualize which problems are most common at different times.</p>
        <div style="display:grid; grid-template-columns:repeat(7,1fr); gap:5px; margin:15px 0;">
          <div style="background:#fee2e2; height:40px; border-radius:6px; text-align:center; line-height:40px;">M</div>
          <div style="background:#fecaca; height:40px; border-radius:6px; text-align:center; line-height:40px;">T</div>
          <div style="background:#fca5a5; height:40px; border-radius:6px; text-align:center; line-height:40px;">W</div>
          <div style="background:#f87171; height:40px; border-radius:6px; text-align:center; line-height:40px;">T</div>
          <div style="background:#ef4444; height:40px; border-radius:6px; text-align:center; line-height:40px; color:white;">F</div>
          <div style="background:#fee2e2; height:40px; border-radius:6px; text-align:center; line-height:40px;">S</div>
          <div style="background:#fee2e2; height:40px; border-radius:6px; text-align:center; line-height:40px;">S</div>
        </div>
        <p class="tool-description" style="font-size:0.85rem;">Friday shows highest problem volume (42% of weekly issues)</p>
      </div>
    </div>

    <!-- ===== PROBLEM ANALYSIS TABLE ===== -->
    <div class="section-header">
      <h2>üìä Detailed Problem Analysis</h2>
      <div class="section-line"></div>
    </div>

    <div class="wide-card tool-card">
      <div>
        <h3>Customer Problems Dashboard</h3>
        <p class="tool-description">Comprehensive view of all customer issues with AI-powered insights.</p>
        <div class="data-table-container">
          <table>
            <thead>
              <tr>
                <th>Problem Type</th>
                <th>Frequency</th>
                <th>Trend</th>
                <th>Avg Resolution Time</th>
                <th>Impact Score</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="problem-table-body">
              <tr><td colspan="7" style="text-align:center;padding:40px;">Loading problem data...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ===== EMAIL BROADCAST SYSTEM (NEW) ===== -->
    <div class="section-header">
      <h2>üìß Mass Email Broadcast</h2>
      <div class="section-line"></div>
    </div>

    <div class="email-broadcast">
      <h3>Communicate with Your Customers</h3>
      <p style="margin:15px 0; opacity:0.9;">Send important updates, product announcements, or personalized offers to your entire customer base.</p>
      
      <div class="email-stats">
        <div class="email-stat">
          <div class="email-stat-number" id="total-recipients">0</div>
          <div class="email-stat-label">Total Customers</div>
        </div>
        <div class="email-stat">
          <div class="email-stat-number" id="emails-sent">0</div>
          <div class="email-stat-label">Emails Sent</div>
        </div>
        <div class="email-stat">
          <div class="email-stat-number" id="open-rate">0%</div>
          <div class="email-stat-label">Avg Open Rate</div>
        </div>
      </div>

      <div style="background:rgba(255,255,255,0.1); padding:30px; border-radius:16px; margin-top:20px;">
        <h4 style="color:white; margin-bottom:20px;">Create New Broadcast</h4>
        
        <div class="input-group" style="margin-bottom:20px;">
          <div style="flex:2;">
            <label style="color:white;">Email Subject</label>
            <input type="text" id="email-subject" placeholder="e.g., Important Update About Your Orders" style="background:white;">
          </div>
          <div style="flex:1;">
            <label style="color:white;">Target Audience</label>
            <select id="email-target" style="background:white;">
              <option value="all">All Customers</option>
              <option value="high-risk">High Risk Customers</option>
              <option value="recent">Recent Customers (30 days)</option>
              <option value="inactive">Inactive (90+ days)</option>
              <option value="problem">Customers with Issues</option>
            </select>
          </div>
        </div>

        <!-- Email Templates -->
        <div class="response-templates">
          <div class="template-item" onclick="loadEmailTemplate('update')">üì¢ Business Update</div>
          <div class="template-item" onclick="loadEmailTemplate('product')">üÜï New Products</div>
          <div class="template-item" onclick="loadEmailTemplate('offer')">üéÅ Special Offer</div>
          <div class="template-item" onclick="loadEmailTemplate('issue')">‚ö†Ô∏è Issue Resolution</div>
          <div class="template-item" onclick="loadEmailTemplate('feedback')">üí¨ Feedback Request</div>
        </div>

        <div style="margin-bottom:20px;">
          <label style="color:white;">Email Content</label>
          <textarea id="email-content" rows="8" placeholder="Write your email content here... Use {{name}} for personalization" style="background:white;"></textarea>
        </div>

        <!-- Preview -->
        <div class="template-preview" id="email-preview">
          <strong>Preview:</strong> Your email will appear here...
        </div>

        <div style="display:flex; gap:15px; margin-top:20px;">
          <button class="btn-primary" onclick="sendBroadcast()" style="flex:2;">üì§ Send Broadcast</button>
          <button class="btn-secondary" onclick="testBroadcast()" style="flex:1;">üì® Send Test</button>
          <button class="btn-secondary" onclick="scheduleBroadcast()" style="flex:1;">‚è∞ Schedule</button>
        </div>
      </div>
    </div>

    <!-- ===== ANALYTICS SECTION ===== -->
    <div class="section-header">
      <h2>üìà Analytics & Predictions</h2>
      <div class="section-line"></div>
    </div>

    <div class="grid">
      <div class="tool-card">
        <div class="icon-box">üìä</div>
        <h3>Sentiment Overview</h3>
        <p class="tool-description">Positive vs Negative across all interactions.</p>
        <canvas id="sentiment-chart" height="260"></canvas>
        <div style="margin-top: 20px; display: flex; justify-content: space-around;">
          <div><span style="color: #28a745;">‚óè</span> Positive: <span id="positive-count">0</span></div>
          <div><span style="color: #dc3545;">‚óè</span> Negative: <span id="negative-count">0</span></div>
          <div><span style="color: #6b7280;">‚óè</span> Neutral: <span id="neutral-count">0</span></div>
        </div>
      </div>

      <div class="tool-card">
        <div class="icon-box">‚ö†Ô∏è</div>
        <h3>Top Recurring Problems</h3>
        <p class="tool-description">Most frequent customer pain points right now.</p>
        <div id="top-issues" style="margin-top:20px;">
          <div style="text-align:center;color:#888;">Analyzing conversations...</div>
        </div>
      </div>

      <div class="tool-card">
        <div class="icon-box">üîÆ</div>
        <h3>Churn Prediction</h3>
        <p class="tool-description">Overall risk level based on negative trends.</p>
        <div style="margin-top:24px;background:#f8f9fa;padding:20px;border-radius:12px;text-align:center;">
          <label style="display:block;margin-bottom:12px;font-weight:600;">Global Churn Risk</label>
          <input type="range" min="0" max="100" value="0" disabled id="global-churn-slider" style="width:100%;accent-color:var(--primary);">
          <div id="global-churn-value" style="font-size:2.4rem;font-weight:800;color:var(--danger);margin-top:12px;">--%</div>
          <div style="margin-top: 10px; font-size: 0.9rem; color: #666;" id="churn-description"></div>
        </div>
      </div>

      <div class="tool-card">
        <div class="icon-box">üìß</div>
        <h3>Proactive Alerts</h3>
        <p class="tool-description">Get instant email notifications on negative sentiment.</p>
        <div style="margin-top:24px;">
          <div style="display:flex;justify-content:space-between;align-items:center;background:#f8f9fa;padding:16px;border-radius:10px;margin-bottom:10px;">
            <span style="font-weight:600;">Enable Real-time Alerts</span>
            <label class="switch">
              <input type="checkbox" id="alert-toggle" checked onchange="toggleAlerts()">
              <span class="slider"></span>
            </label>
          </div>
          <div id="alert-status" style="font-size:0.9rem; color: #28a745;">‚úì Alerts are active</div>
        </div>
      </div>
    </div>

    <!-- ===== PREMIUM BUSINESS TOOLS ===== -->
    <div class="section-header">
      <h2>üõ†Ô∏è Premium Business Tools</h2>
      <div class="section-line"></div>
    </div>

    <div class="grid">
      <div class="tool-card">
        <div class="icon-box">üí°</div>
        <h3>AI Resolution Generator</h3>
        <p class="tool-description">Instant email/call scripts for any issue.</p>
        <select id="resolution-type" style="margin-bottom: 10px;">
          <option value="email">Email Response</option>
          <option value="call">Call Script</option>
          <option value="chat">Chat Response</option>
        </select>
        <textarea id="resolution-input" placeholder="Describe the customer issue..." rows="3"></textarea>
        <button class="btn-save" onclick="generateResolution()" style="margin-top:12px; width: 100%;">Generate Fix</button>
        <div id="resolution-output" style="margin-top:20px;min-height:120px;padding:15px;background:#f8f9fa;border-radius:8px;line-height:1.6;"></div>
      </div>

      <div class="tool-card">
        <div class="icon-box">üìâ</div>
        <h3>Sentiment Trend</h3>
        <p class="tool-description">Weekly negative sentiment movement.</p>
        <canvas id="trend-chart" height="200"></canvas>
        <div style="margin-top: 10px; text-align: center;">
          <button class="btn-secondary" onclick="refreshTrendData()">‚Üª Refresh</button>
        </div>
      </div>

      <div class="tool-card">
        <div class="icon-box">üë•</div>
        <h3>AI Customer Personas</h3>
        <p class="tool-description">Auto-generated profiles from real chats.</p>
        <div id="persona-output" style="margin-top:16px; min-height: 100px;"></div>
        <button class="btn-save" onclick="generatePersonas()" style="margin-top:16px; width: 100%;">Generate Personas</button>
      </div>

      <div class="tool-card">
        <div class="icon-box">ü§ù</div>
        <h3>Team Notes & Tasks</h3>
        <p class="tool-description">Internal notes & task assignments.</p>
        <textarea id="team-note" placeholder="Add note or assign task..." rows="3"></textarea>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
          <button class="btn-save" onclick="saveTeamNote()" style="flex: 1;">Save & Share</button>
          <button class="btn-secondary" onclick="loadTeamNotes()" style="flex: 1;">View Notes</button>
        </div>
        <div id="notes-list" style="margin-top: 15px; max-height: 150px; overflow-y: auto;"></div>
      </div>
    </div>

    <!-- ===== EXPORT BUTTONS ===== -->
    <div style="text-align:center;margin:70px 0; display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
      <button class="btn-save" style="padding:16px 60px;font-size:1.15rem;" onclick="exportInsights()">
        üì• Export Full Report (CSV)
      </button>
      <button class="btn-info" style="padding:16px 60px;font-size:1.15rem;" onclick="exportProblemReport()">
        üìä Export Problem Analysis
      </button>
      <button class="btn-secondary" style="padding:16px 60px;font-size:1.15rem;" onclick="refreshAllData()">
        ‚Üª Refresh All Data
      </button>
    </div>

  </div>
</div>

<footer>
  <p>¬© 2026 AI Smart Business Hub | Powered by Cloudflare AI</p>
</footer>

<script>
// ================================================
// CUSTOMER INSIGHTS - ENHANCED PROBLEM-SOLVING VERSION
// ================================================

// ===== CONFIGURATION =====
const BACKEND_URL = 'https://ai-smart-hub.onrender.com';
const AI_CHAT_ENDPOINT = `${BACKEND_URL}/api/customer-insights/ai-chat`;

// ===== GLOBAL STATE =====
let customers = [];
let allChats = {};
let filteredCustomers = [];
let sentimentChart = null;
let trendChart = null;
let sentimentTimeline = null;
let pollingInterval = null;
let currentSort = { field: 'risk', direction: 'desc' };
let currentFilters = {
    search: '',
    sentiment: 'all',
    problem: 'all',
    dateFrom: null,
    dateTo: null
};
let problemStats = {
    delivery: 0,
    quality: 0,
    pricing: 0,
    support: 0,
    refund: 0,
    ux: 0,
    total: 0,
    critical: 0
};

// Admin email
const ADMIN_EMAIL = "ericchung992@gmail.com";

// ===== IMMEDIATE UNLOCK =====
(function() {
    console.log("üîì Initializing Customer Insights...");
    
    // Force unlock for admin
    try {
        const token = localStorage.getItem('token');
        if (token) {
            const payload = JSON.parse(atob(token.split('.')[1]));
            if (payload.email === ADMIN_EMAIL || payload.plan === 'agency') {
                setTimeout(() => {
                    const lock = document.getElementById('plan-lock');
                    const main = document.getElementById('main-content');
                    if (lock) {
                        lock.classList.add('hidden');
                        lock.style.display = 'none';
                    }
                    if (main) {
                        main.classList.remove('hidden');
                        main.style.display = 'block';
                        main.style.visibility = 'visible';
                    }
                    localStorage.setItem('currentPlan', 'agency');
                }, 100);
            }
        }
    } catch (e) {
        console.log("Init error:", e);
    }
})();

// ===== DATA LOADING =====
async function loadCustomers(silent = false) {
    const tbody = document.getElementById('customer-table-body');
    if (!tbody) return;

    try {
        const token = localStorage.getItem('token');
        if (!token) {
            showError("Please log in again");
            return;
        }

        if (!silent) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:60px;"><div class="loading-spinner" style="margin:0 auto;"></div><br>Loading customer data...</td></tr>';
        }

        console.log("Fetching leads...");
        const leadsRes = await fetch(`${BACKEND_URL}/api/customer-insights/leads`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!leadsRes.ok) {
            if (leadsRes.status === 401) {
                window.location.href = 'login.html';
                return;
            }
            throw new Error(`Failed to load leads: ${leadsRes.status}`);
        }

        customers = await leadsRes.json() || [];
        console.log(`Loaded ${customers.length} customers`);

        document.getElementById('customer-count').textContent = `${customers.length} Total Customers`;
        document.getElementById('total-recipients').textContent = customers.length;

        const chatPromises = customers.map(async (c) => {
            try {
                const chatRes = await fetch(`${BACKEND_URL}/api/customer-insights/chats?email=${encodeURIComponent(c.email || '')}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (chatRes.ok) {
                    const chats = await chatRes.json();
                    return chats.map(chat => ({
                        ...chat,
                        sentiment: chat.sentiment || 'neutral',
                        problem: detectProblem(chat.message || '')
                    }));
                }
                return [];
            } catch {
                return [];
            }
        });

        const chatResults = await Promise.all(chatPromises);
        
        allChats = {};
        customers.forEach((c, i) => {
            if (c && c.email) {
                allChats[c.email] = chatResults[i] || [];
            }
        });

        console.log("Data loaded successfully");
        analyzeProblems();
        applyFilters();
        updateAnalytics();
        updateProblemStats();
        
    } catch (err) {
        console.error("Data load error:", err);
        if (tbody) {
            tbody.innerHTML = `<tr><td colspan="6" style="color:var(--danger);padding:60px;text-align:center;">
                Error loading data: ${err.message}<br>
                <button onclick="loadCustomers()" style="margin-top:10px;padding:8px 20px;background:var(--primary);color:white;border:none;border-radius:6px;cursor:pointer;">Retry</button>
            </td></tr>`;
        }
    }
}

// ===== PROBLEM DETECTION =====
function detectProblem(message) {
    if (!message) return 'other';
    const msg = message.toLowerCase();
    
    if (msg.match(/delay|late|shipping|delivery|when will|arrive|tracking/)) return 'delivery';
    if (msg.match(/quality|defective|broken|damaged|poor|bad|not working/)) return 'quality';
    if (msg.match(/price|expensive|cost|money|too much|refund|return/)) return 'pricing';
    if (msg.match(/help|support|agent|human|talk to|speak with/)) return 'support';
    if (msg.match(/refund|return|money back|cancel/)) return 'refund';
    if (msg.match(/confused|understand|how to|complicated|difficult/)) return 'ux';
    
    return 'other';
}

// ===== PROBLEM ANALYSIS =====
function analyzeProblems() {
    problemStats = {
        delivery: 0,
        quality: 0,
        pricing: 0,
        support: 0,
        refund: 0,
        ux: 0,
        other: 0,
        total: 0,
        critical: 0
    };
    
    Object.values(allChats).forEach(chats => {
        chats.forEach(chat => {
            if (chat.message) {
                const problem = chat.problem || detectProblem(chat.message);
                problemStats[problem] = (problemStats[problem] || 0) + 1;
                problemStats.total++;
                
                if (chat.sentiment === 'negative' && problem !== 'other') {
                    problemStats.critical++;
                }
            }
        });
    });
    
    // Update UI stats
    document.getElementById('total-problems').textContent = problemStats.total;
    document.getElementById('critical-problems').textContent = problemStats.critical;
    document.getElementById('problem-count').textContent = `${problemStats.total} Total Issues`;
    
    // Update problem stats in classifier
    document.getElementById('stat-delivery').textContent = problemStats.delivery;
    document.getElementById('stat-quality').textContent = problemStats.quality;
    document.getElementById('stat-pricing').textContent = problemStats.pricing;
    document.getElementById('stat-support').textContent = problemStats.support;
    
    // Update risk counts
    updateRiskCounts();
    
    // Render problem table
    renderProblemTable();
}

function updateRiskCounts() {
    let highRisk = 0;
    let mediumRisk = 0;
    
    customers.forEach(c => {
        const chats = allChats[c.email] || [];
        const risk = calculateRisk(chats);
        if (risk > 70) highRisk++;
        else if (risk > 40) mediumRisk++;
    });
    
    document.getElementById('high-risk-count').textContent = highRisk;
    document.getElementById('medium-risk-count').textContent = mediumRisk;
}

function renderProblemTable() {
    const tbody = document.getElementById('problem-table-body');
    if (!tbody) return;
    
    const problems = [
        { type: 'Delivery Issues', key: 'delivery', freq: problemStats.delivery, trend: '+12%', resolution: '2.5h', impact: 85 },
        { type: 'Product Quality', key: 'quality', freq: problemStats.quality, trend: '+5%', resolution: '3.2h', impact: 92 },
        { type: 'Pricing Concerns', key: 'pricing', freq: problemStats.pricing, trend: '-3%', resolution: '1.8h', impact: 45 },
        { type: 'Support Requests', key: 'support', freq: problemStats.support, trend: '+8%', resolution: '4.1h', impact: 78 },
        { type: 'Refund Requests', key: 'refund', freq: problemStats.refund, trend: '-2%', resolution: '2.0h', impact: 95 },
        { type: 'UX/Confusion', key: 'ux', freq: problemStats.ux, trend: '+15%', resolution: '1.5h', impact: 60 }
    ];
    
    tbody.innerHTML = problems.map(p => `
        <tr>
            <td><strong>${p.type}</strong></td>
            <td>${p.freq}</td>
            <td><span style="color: ${p.trend.startsWith('+') ? '#dc3545' : '#28a745'}">${p.trend}</span></td>
            <td>${p.resolution}</td>
            <td><span class="status-badge ${p.impact > 80 ? 'badge-high' : p.impact > 60 ? 'badge-med' : 'badge-low'}">${p.impact}</span></td>
            <td><span class="status-badge ${p.freq > 20 ? 'badge-high' : 'badge-med'}">${p.freq > 20 ? 'Critical' : 'Monitoring'}</span></td>
            <td>
                <button class="btn-secondary" style="padding:4px 8px; font-size:0.85rem;" onclick="analyzeProblemType('${p.key}')">Analyze</button>
            </td>
        </tr>
    `).join('');
}

// ===== FILTERING AND SORTING =====
function applyFilters() {
    const searchInput = document.getElementById('customer-search');
    const sentimentFilter = document.getElementById('sentiment-filter');
    const problemFilter = document.getElementById('problem-filter');
    const dateFrom = document.getElementById('date-from');
    const dateTo = document.getElementById('date-to');
    
    currentFilters = {
        search: searchInput ? searchInput.value.toLowerCase() : '',
        sentiment: sentimentFilter ? sentimentFilter.value : 'all',
        problem: problemFilter ? problemFilter.value : 'all',
        dateFrom: dateFrom && dateFrom.value ? new Date(dateFrom.value) : null,
        dateTo: dateTo && dateTo.value ? new Date(dateTo.value) : null
    };
    
    if (currentFilters.dateTo) {
        currentFilters.dateTo.setHours(23, 59, 59, 999);
    }
    
    filterAndSortCustomers();
}

function resetFilters() {
    document.getElementById('customer-search').value = '';
    document.getElementById('sentiment-filter').value = 'all';
    document.getElementById('problem-filter').value = 'all';
    document.getElementById('date-from').value = '';
    document.getElementById('date-to').value = '';
    
    currentFilters = {
        search: '',
        sentiment: 'all',
        problem: 'all',
        dateFrom: null,
        dateTo: null
    };
    
    filterAndSortCustomers();
}

function filterAndSortCustomers() {
    filteredCustomers = customers.filter(c => {
        if (currentFilters.search) {
            const name = (c.name || '').toLowerCase();
            const email = (c.email || '').toLowerCase();
            if (!name.includes(currentFilters.search) && !email.includes(currentFilters.search)) {
                return false;
            }
        }
        
        if (currentFilters.sentiment !== 'all') {
            const chats = allChats[c.email] || [];
            const hasMatchingSentiment = chats.some(chat => 
                (chat.sentiment || 'neutral').toLowerCase() === currentFilters.sentiment.toLowerCase()
            );
            if (!hasMatchingSentiment) return false;
        }
        
        if (currentFilters.problem !== 'all') {
            const chats = allChats[c.email] || [];
            const hasMatchingProblem = chats.some(chat => 
                (chat.problem || detectProblem(chat.message || '')) === currentFilters.problem
            );
            if (!hasMatchingProblem) return false;
        }
        
        if (currentFilters.dateFrom || currentFilters.dateTo) {
            const chats = allChats[c.email] || [];
            const hasChatInDateRange = chats.some(chat => {
                if (!chat.timestamp) return false;
                const chatDate = new Date(chat.timestamp);
                if (currentFilters.dateFrom && chatDate < currentFilters.dateFrom) return false;
                if (currentFilters.dateTo && chatDate > currentFilters.dateTo) return false;
                return true;
            });
            if (!hasChatInDateRange) return false;
        }
        
        return true;
    });
    
    sortCustomers();
}

function sortTable(field) {
    if (currentSort.field === field) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.field = field;
        currentSort.direction = 'desc';
    }
    sortCustomers();
}

function sortCustomers() {
    filteredCustomers.sort((a, b) => {
        let valA, valB;
        
        switch(currentSort.field) {
            case 'name':
                valA = a.name || '';
                valB = b.name || '';
                break;
            case 'email':
                valA = a.email || '';
                valB = b.email || '';
                break;
            case 'messages':
                valA = (allChats[a.email] || []).length;
                valB = (allChats[b.email] || []).length;
                break;
            case 'risk':
                valA = calculateRisk(allChats[a.email] || []);
                valB = calculateRisk(allChats[b.email] || []);
                break;
            default:
                return 0;
        }
        
        if (typeof valA === 'string') {
            return currentSort.direction === 'asc' 
                ? valA.localeCompare(valB)
                : valB.localeCompare(valA);
        } else {
            return currentSort.direction === 'asc' 
                ? valA - valB
                : valB - valA;
        }
    });
    
    renderCustomers();
}

// ===== RENDERING =====
function renderCustomers() {
    const tbody = document.getElementById('customer-table-body');
    if (!tbody) return;

    if (filteredCustomers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:60px;color:#777;">No matching customers found</td></tr>';
        return;
    }

    tbody.innerHTML = '';
    
    filteredCustomers.forEach(c => {
        const chats = allChats[c.email] || [];
        const messages = chats.length;
        const negCount = chats.filter(m => (m.sentiment || 'neutral').toLowerCase() === 'negative').length;
        const posCount = chats.filter(m => (m.sentiment || 'neutral').toLowerCase() === 'positive').length;
        const risk = calculateRisk(chats);
        
        // Get unique problems
        const problems = [...new Set(chats.map(chat => chat.problem || detectProblem(chat.message || '')))];
        const problemTags = problems.filter(p => p !== 'other').map(p => {
            const colors = {
                delivery: '#f59e0b',
                quality: '#dc3545',
                pricing: '#3b82f6',
                support: '#8b5cf6',
                refund: '#ef4444',
                ux: '#10b981'
            };
            return `<span style="background:${colors[p] || '#6c757d'}; color:white; padding:2px 8px; border-radius:12px; font-size:0.8rem; margin:2px;">${p}</span>`;
        }).join(' ');
        
        let sentimentDisplay = '';
        if (messages > 0) {
            if (negCount > posCount) {
                sentimentDisplay = `<span style="color: #dc3545;">üî¥ ${negCount} negative</span>`;
            } else if (posCount > negCount) {
                sentimentDisplay = `<span style="color: #28a745;">üü¢ ${posCount} positive</span>`;
            } else {
                sentimentDisplay = `<span style="color: #6b7280;">‚ö™ ${messages} messages</span>`;
            }
        } else {
            sentimentDisplay = 'No messages';
        }

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><strong>${c.name || 'Visitor'}</strong></td>
            <td>${c.email || 'No email'}</td>
            <td>${messages} ${messages > 0 ? `(${sentimentDisplay})` : ''}</td>
            <td><span class="status-badge ${risk > 70 ? 'badge-high' : risk > 40 ? 'badge-med' : 'badge-low'}" style="font-size:1rem; font-weight:700;">${risk}%</span></td>
            <td>${problemTags || '‚Äî'}</td>
            <td>
                <button class="btn-save" style="padding:6px 12px; margin-right:5px;" onclick="viewCustomer('${c.email}')">View</button>
                <button class="btn-secondary" style="padding:6px 12px;" onclick="quickAnalyze('${c.email}')">Analyze</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// ===== CUSTOMER VIEW FUNCTIONS =====
function viewCustomer(email) {
    const div = document.getElementById('ai-chat-messages');
    if (!div) return;

    div.innerHTML = '<div class="ai-typing"><div class="loading-spinner" style="margin:0 auto;"></div>Loading conversation...</div>';

    const chats = allChats[email] || [];

    if (chats.length === 0) {
        div.innerHTML = '<div style="padding:60px;text-align:center;color:#888;">No chat history for this customer.</div>';
        return;
    }

    div.innerHTML = '';
    chats.forEach(chat => {
        const sentiment = chat.sentiment || 'neutral';
        const sentimentEmoji = sentiment === 'positive' ? 'üòä' : sentiment === 'negative' ? 'üòû' : 'üòê';
        const problem = chat.problem || detectProblem(chat.message || '');
        
        div.innerHTML += `
            <div class="message user"><strong>Customer ${sentimentEmoji}:</strong> ${chat.message || '[No message]'}</div>
            <div class="message bot"><strong>AI:</strong> ${chat.response || '[No reply]'}</div>
            ${problem !== 'other' ? `<div style="font-size:0.8rem; color:#666; margin-bottom:10px;">üè∑Ô∏è Problem: ${problem}</div>` : ''}
        `;
    });
    div.scrollTop = div.scrollHeight;

    setTimeout(() => {
        sendAiMessage(`Give a detailed analysis of customer ${email} including main issues, sentiment trends, and recommended actions.`);
    }, 500);
}

function quickAnalyze(email) {
    sendAiMessage(`Quick analysis for customer ${email}: What are their top 3 issues and suggested solutions?`);
}

// ===== AI CHAT =====
async function sendAiMessage(autoQuery = null) {
    const input = document.getElementById('ai-input');
    const query = autoQuery || input?.value?.trim();
    
    if (!query) return;

    const div = document.getElementById('ai-chat-messages');
    if (!div) return;

    const thinkingId = 'think-' + Date.now();
    div.innerHTML += `<div id="${thinkingId}" class="ai-typing"><div class="loading-spinner" style="margin:0 auto;"></div>Cloudflare AI thinking...</div>`;
    div.scrollTop = div.scrollHeight;

    if (!autoQuery && input) input.value = '';

    try {
        const token = localStorage.getItem('token');
        const res = await fetch(AI_CHAT_ENDPOINT, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ query })
        });

        if (!res.ok) {
            throw new Error(`AI service error: ${res.status}`);
        }

        const data = await res.json();
        
        let formattedResponse = data.reply || 'No response from AI.';
        formattedResponse = formattedResponse.replace(/\n/g, '<br>');
        
        document.getElementById(thinkingId).outerHTML = `
            <div class="message bot">
                <strong>AI:</strong><br>${formattedResponse}
            </div>
        `;
    } catch (err) {
        console.error("AI error:", err);
        document.getElementById(thinkingId).outerHTML = `
            <div class="message bot" style="color:var(--danger);">
                <strong>Error:</strong> ${err.message}<br>
                <small>Please try again or check your connection.</small>
            </div>
        `;
    }

    div.scrollTop = div.scrollHeight;
}

// ===== PROBLEM-SOLVING TOOLS =====

// Smart Response Generator
function generateSmartResponse() {
    const problemType = document.getElementById('response-problem-type').value;
    const context = document.getElementById('response-context').value;
    const output = document.getElementById('response-output');
    
    const responses = {
        delivery: "Thank you for reaching out about your delivery. I understand waiting for your order is frustrating. Let me check the status right away and provide you with a tracking update. We value your patience and will ensure this gets resolved promptly.",
        quality: "I'm sorry to hear about the quality issue with your product. This is not the experience we want you to have. Please provide your order number and I'll process a replacement or refund immediately.",
        refund: "I understand you'd like a refund. We want you to be completely satisfied with your purchase. I'll process your refund right away - it should reflect in your account within 3-5 business days.",
        support: "I'm here to help! Could you please provide more details about what you need assistance with? I'll do my best to resolve your issue quickly.",
        complaint: "Thank you for bringing this to our attention. I sincerely apologize for your experience. Let me escalate this to our team and ensure this is addressed properly."
    };
    
    let response = responses[problemType] || "Thank you for contacting us. How can I help you today?";
    if (context) {
        response += `\n\nRegarding: ${context}`;
    }
    
    output.style.display = 'block';
    output.innerHTML = `<strong>ü§ñ Generated Response:</strong><br>${response}`;
    
    // Copy to clipboard option
    navigator.clipboard.writeText(response).then(() => {
        showTemporaryMessage('Response copied to clipboard!');
    });
}

// Show at-risk customers
function showAtRiskCustomers() {
    const highRisk = customers.filter(c => {
        const chats = allChats[c.email] || [];
        return calculateRisk(chats) > 70;
    });
    
    if (highRisk.length === 0) {
        alert('No high-risk customers found.');
        return;
    }
    
    let message = 'üî¥ High-Risk Customers:\n\n';
    highRisk.slice(0, 5).forEach(c => {
        const risk = calculateRisk(allChats[c.email] || []);
        message += `${c.name || 'Visitor'} (${c.email}) - ${risk}% risk\n`;
    });
    
    alert(message);
}

// Problem analysis functions
function analyzeProblemType(type) {
    sendAiMessage(`Analyze all ${type} related customer issues and suggest improvements to reduce these problems.`);
}

function analyzeProblemTrends() {
    sendAiMessage('Analyze the trends in customer problems over the last 30 days and identify which issues are increasing.');
}

// Knowledge base suggestions
function refreshKnowledgeSuggestions() {
    const suggestions = [
        { topic: "Delivery times", count: problemStats.delivery },
        { topic: "Return policy", count: problemStats.refund + 5 },
        { topic: "Sizing guide", count: problemStats.ux + 8 },
        { topic: "Product quality", count: problemStats.quality },
        { topic: "Pricing FAQ", count: problemStats.pricing }
    ];
    
    const container = document.getElementById('knowledge-suggestions');
    container.innerHTML = suggestions
        .filter(s => s.count > 5)
        .map(s => `
            <div style="padding:10px; background:#f8f9fa; border-radius:8px; margin-bottom:5px;">
                <strong>üìù "${s.topic}"</strong> - ${s.count} mentions
            </div>
        `).join('');
}

// Sentiment timeline
function refreshSentimentTimeline() {
    if (!sentimentTimeline) return;
    
    const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    const data = days.map(() => Math.floor(Math.random() * 40) + 20); // Mock data
    
    sentimentTimeline.data.datasets[0].data = data;
    sentimentTimeline.update();
}

// Ticket settings
function saveTicketSettings() {
    const threshold = document.getElementById('ticket-threshold').value;
    const assignee = document.getElementById('ticket-assignee').value;
    localStorage.setItem('ticketThreshold', threshold);
    localStorage.setItem('ticketAssignee', assignee);
    showTemporaryMessage('Ticket settings saved!');
}

// Problem tab switching
function switchProblemTab(tab) {
    document.querySelectorAll('.problem-tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    
    // Filter the problem table
    if (tab === 'all') {
        renderProblemTable();
    } else {
        const filteredProblems = [{
            type: tab.charAt(0).toUpperCase() + tab.slice(1) + ' Issues',
            freq: problemStats[tab] || 0,
            trend: '+5%',
            resolution: '2.5h',
            impact: 75
        }];
        
        const tbody = document.getElementById('problem-table-body');
        tbody.innerHTML = filteredProblems.map(p => `
            <tr>
                <td><strong>${p.type}</strong></td>
                <td>${p.freq}</td>
                <td><span style="color: #f59e0b">${p.trend}</span></td>
                <td>${p.resolution}</td>
                <td><span class="status-badge badge-med">${p.impact}</span></td>
                <td><span class="status-badge ${p.freq > 20 ? 'badge-high' : 'badge-med'}">${p.freq > 20 ? 'Critical' : 'Monitoring'}</span></td>
                <td>
                    <button class="btn-secondary" style="padding:4px 8px;" onclick="analyzeProblemType('${tab}')">Analyze</button>
                </td>
            </tr>
        `).join('');
    }
}

// ===== FIXED EMAIL BROADCAST FUNCTIONS =====
function loadEmailTemplate(type) {
    const subject = document.getElementById('email-subject');
    const content = document.getElementById('email-content');
    const preview = document.getElementById('email-preview');
    
    const templates = {
        update: {
            subject: "Important Update About Your Orders",
            content: "Dear {{name}},\n\nWe wanted to share an important update about our service. Starting next week, we're introducing faster delivery options and extended customer support hours.\n\nYour satisfaction is our priority, and we're constantly working to improve your experience.\n\nThank you for being a valued customer.\n\nBest regards,\nThe Team"
        },
        product: {
            subject: "New Products Just Arrived!",
            content: "Hi {{name}},\n\nWe're excited to announce our newest collection has just arrived! From trendy styles to classic essentials, there's something for everyone.\n\nShop the collection now and enjoy 10% off your first order of new items.\n\nHappy shopping!\nThe Team"
        },
        offer: {
            subject: "Special Offer Just for You",
            content: "Dear {{name}},\n\nAs a valued customer, we'd like to offer you an exclusive 20% discount on your next purchase. Use code THANKYOU20 at checkout.\n\nThis offer is valid for the next 7 days.\n\nWe appreciate your business!\n\nThe Team"
        },
        issue: {
            subject: "Update Regarding Your Recent Issue",
            content: "Dear {{name}},\n\nWe wanted to follow up on the issue you recently experienced. Our team has resolved the problem and implemented measures to prevent it from happening again.\n\nAs a token of our appreciation, we've added a credit to your account.\n\nThank you for your patience and understanding.\n\nSincerely,\nCustomer Support"
        },
        feedback: {
            subject: "We'd Love Your Feedback",
            content: "Hi {{name}},\n\nWe're always looking to improve, and your opinion matters! Could you take 2 minutes to share your thoughts about your experience with us?\n\nClick here to take the survey: [SURVEY_LINK]\n\nThank you for helping us serve you better!\n\nThe Team"
        }
    };
    
    if (templates[type]) {
        subject.value = templates[type].subject;
        content.value = templates[type].content;
        updateEmailPreview();
    }
}

function updateEmailPreview() {
    const subject = document.getElementById('email-subject').value;
    const content = document.getElementById('email-content').value;
    const preview = document.getElementById('email-preview');
    
    // Simple preview with placeholder
    let previewContent = content.replace(/{{name}}/g, 'John Doe');
    preview.innerHTML = `<strong>Preview:</strong><br>üìß ${subject}<br><br>${previewContent}`;
}

// FIXED: Actually sends test email to the backend
async function testBroadcast() {
    const subject = document.getElementById('email-subject').value;
    const content = document.getElementById('email-content').value;
    
    if (!subject || !content) {
        alert('Please enter both subject and content');
        return;
    }
    
    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${BACKEND_URL}/api/broadcast/test`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ subject, content })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showTemporaryMessage(data.message || '‚úÖ Test email sent! Check your inbox.');
            console.log('Test email sent:', data);
        } else {
            showTemporaryMessage('‚ùå Failed to send test email: ' + data.error, 'error');
        }
    } catch (err) {
        console.error('Test email error:', err);
        showTemporaryMessage('‚ùå Error sending test email', 'error');
    }
}

// FIXED: Actually sends broadcast to all customers
async function sendBroadcast() {
    const subject = document.getElementById('email-subject').value;
    const content = document.getElementById('email-content').value;
    const target = document.getElementById('email-target').value;
    
    if (!subject || !content) {
        alert('Please enter both subject and content');
        return;
    }
    
    let recipientCount = customers.length;
    if (target === 'high-risk') {
        recipientCount = customers.filter(c => calculateRisk(allChats[c.email] || []) > 70).length;
    } else if (target === 'recent') {
        recipientCount = Math.floor(customers.length * 0.3);
    }
    
    if (!confirm(`Send this email to ${recipientCount} customers?`)) {
        return;
    }
    
    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${BACKEND_URL}/api/broadcast/send`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ subject, content, target })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showTemporaryMessage(data.message || `‚úÖ Broadcast sent to ${data.stats?.sent || recipientCount} customers!`);
            
            // Update stats
            const sent = document.getElementById('emails-sent');
            sent.textContent = parseInt(sent.textContent) + (data.stats?.sent || recipientCount);
            
            console.log('Broadcast result:', data);
        } else {
            showTemporaryMessage('‚ùå Failed to send broadcast: ' + data.error, 'error');
        }
    } catch (err) {
        console.error('Broadcast error:', err);
        showTemporaryMessage('‚ùå Error sending broadcast', 'error');
    }
}

function scheduleBroadcast() {
    alert('Schedule feature coming soon! You will be able to set specific dates and times for automated broadcasts.');
}

// ===== ANALYTICS =====
function updateAnalytics() {
    let pos = 0, neg = 0, neu = 0;
    let maxRisk = 0;
    let totalMessages = 0;
    
    Object.entries(allChats).forEach(([email, chats]) => {
        chats.forEach(msg => {
            const s = (msg.sentiment || 'neutral').toLowerCase();
            if (s === 'positive') pos++;
            else if (s === 'negative') neg++;
            else neu++;
            totalMessages++;
        });
        
        const risk = calculateRisk(chats);
        maxRisk = Math.max(maxRisk, risk);
    });

    document.getElementById('positive-count').textContent = pos;
    document.getElementById('negative-count').textContent = neg;
    document.getElementById('neutral-count').textContent = neu;

    const total = pos + neg + neu || 1;
    if (sentimentChart) {
        sentimentChart.data.datasets[0].data = [
            Math.round(pos / total * 100),
            Math.round(neg / total * 100),
            Math.round(neu / total * 100)
        ];
        sentimentChart.update();
    }

    const valueEl = document.getElementById('global-churn-value');
    const slider = document.getElementById('global-churn-slider');
    const descEl = document.getElementById('churn-description');
    
    if (valueEl && slider) {
        slider.value = maxRisk;
        valueEl.textContent = `${maxRisk}%`;
        valueEl.style.color = maxRisk > 70 ? '#dc3545' : maxRisk > 40 ? '#f59e0b' : '#28a745';
        
        if (descEl) {
            if (maxRisk > 70) {
                descEl.innerHTML = '‚ö†Ô∏è High risk - Immediate action required';
                descEl.style.color = '#dc3545';
            } else if (maxRisk > 40) {
                descEl.innerHTML = 'üìä Moderate risk - Monitor closely';
                descEl.style.color = '#f59e0b';
            } else {
                descEl.innerHTML = '‚úÖ Low risk - Keep up the good work';
                descEl.style.color = '#28a745';
            }
        }
    }

    updateTopIssues();
    updateTrendData();
}

function updateProblemStats() {
    document.getElementById('avg-resolution').textContent = '2.4h';
    document.getElementById('satisfaction-rate').textContent = '87%';
}

function updateTopIssues() {
    const issuesDiv = document.getElementById('top-issues');
    if (!issuesDiv) return;

    const issues = [
        { label: 'Delivery Issues', count: problemStats.delivery },
        { label: 'Product Quality', count: problemStats.quality },
        { label: 'Pricing Concerns', count: problemStats.pricing },
        { label: 'Support Requests', count: problemStats.support },
        { label: 'Refund Requests', count: problemStats.refund }
    ].sort((a, b) => b.count - a.count).slice(0, 3);

    if (issues.every(i => i.count === 0)) {
        issuesDiv.innerHTML = '<div style="text-align:center;color:#888;">No problems detected</div>';
        return;
    }

    issuesDiv.innerHTML = issues.map(issue => `
        <div style="margin-bottom:10px; padding:8px; background:#f8f9fa; border-radius:6px;">
            <strong>${issue.label}</strong><br>
            <small>${issue.count} mentions</small>
        </div>
    `).join('');
}

function updateTrendData() {
    if (!trendChart) return;
    
    const weeks = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
    const data = [12, 19, 15, 22]; // Mock data
    
    trendChart.data.labels = weeks;
    trendChart.data.datasets[0].data = data;
    trendChart.update();
}

function refreshTrendData() {
    updateTrendData();
    showTemporaryMessage('Trend data refreshed');
}

// ===== UTILITIES =====
function calculateRisk(chats) {
    if (!chats || chats.length === 0) return 0;
    
    const negatives = chats.filter(c => (c.sentiment || 'neutral').toLowerCase() === 'negative').length;
    const recency = Math.min(chats.length * 2, 30);
    const negativeWeight = Math.min(negatives * 15, 70);
    
    return Math.min(negativeWeight + recency, 100);
}

function showTemporaryMessage(msg, type = 'success') {
    const div = document.createElement('div');
    div.className = type === 'success' ? 'success-message' : 'error-message';
    div.textContent = msg;
    div.style.position = 'fixed';
    div.style.top = '20px';
    div.style.right = '20px';
    div.style.zIndex = '9999';
    document.body.appendChild(div);
    
    setTimeout(() => div.remove(), 3000);
}

function showError(msg) {
    showTemporaryMessage(msg, 'error');
}

function refreshAllData() {
    loadCustomers();
    showTemporaryMessage('Refreshing all data...');
}

// ===== WIDGET FUNCTIONS =====
function showAIWidget() {
    const area = document.getElementById('widget-preview-area');
    if (!area) return;

    const businessName = customers[0]?.name || 'Your Business';
    const totalChats = Object.values(allChats).reduce((acc, chats) => acc + chats.length, 0);
    const totalLeads = customers.length;

    area.innerHTML = `
        <div style="padding:30px; background: linear-gradient(135deg, var(--primary) 0%, #b8962e 100%); border-radius:12px; color:white; text-align:left;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="color:white;">${businessName} AI Assistant</h3>
                <span style="background:rgba(255,255,255,0.2); padding:5px 10px; border-radius:20px;">Agency Plan</span>
            </div>
            <p>üëã Hi! I'm your AI assistant. I can help with:</p>
            <ul style="margin:20px 0; padding-left:20px;">
                <li>Customer insights (${totalLeads} active customers)</li>
                <li>Chat analysis (${totalChats} messages analyzed)</li>
                <li>Problem detection (${problemStats.total} issues found)</li>
                <li>Churn prediction and prevention</li>
                <li>Automated issue resolution</li>
            </ul>
            <div style="background:white; border-radius:8px; padding:15px; margin-top:20px;">
                <input type="text" placeholder="Ask me anything about your customers..." style="width:100%; border:1px solid #ddd; margin-bottom:10px;" disabled>
                <button style="background:var(--primary); color:white; border:none; padding:10px 20px; border-radius:6px; width:100%;" disabled>Send (Preview Mode)</button>
            </div>
            <p style="font-size:0.8rem; margin-top:15px; text-align:center; opacity:0.8;">This is how your customers see the widget</p>
        </div>
    `;
}

// ===== PREMIUM TOOLS =====
function generateResolution() {
    const input = document.getElementById('resolution-input');
    const type = document.getElementById('resolution-type');
    const output = document.getElementById('resolution-output');
    
    if (!input || !output) return;
    
    const issue = input.value.trim();
    if (!issue) {
        output.innerHTML = 'Please describe the customer issue first.';
        return;
    }

    output.innerHTML = '<div class="loading-spinner" style="margin:0 auto;"></div> Generating response...';

    setTimeout(() => {
        let response = '';
        switch(type.value) {
            case 'email':
                response = `
                    <strong>üìß Email Response:</strong><br><br>
                    Dear Valued Customer,<br><br>
                    Thank you for bringing this to our attention. I understand you're experiencing: "${issue}"<br><br>
                    I've investigated this matter and here's what we'll do:<br>
                    1. Escalate to our senior team immediately<br>
                    2. Provide regular updates within 24 hours<br>
                    3. Apply a goodwill credit to your account<br><br>
                    We value your business and apologize for any inconvenience.<br><br>
                    Best regards,<br>
                    Customer Success Team
                `;
                break;
            case 'call':
                response = `
                    <strong>üìû Call Script:</strong><br><br>
                    "Hello [Customer Name], this is [Your Name] from Customer Success.<br><br>
                    I understand you're having an issue with: ${issue}<br><br>
                    I want to assure you that we're taking this very seriously. Here's what I can do for you:<br>
                    ‚Ä¢ Investigate immediately<br>
                    ‚Ä¢ Provide updates every 2 hours<br>
                    ‚Ä¢ Ensure this doesn't happen again<br><br>
                    Is there anything specific you'd like me to address right now?"
                `;
                break;
            case 'chat':
                response = `
                    <strong>üí¨ Chat Response:</strong><br><br>
                    Hi there! üëã<br><br>
                    I'm sorry to hear you're experiencing: ${issue}<br><br>
                    Let me help you right away:<br>
                    ‚Ä¢ I've created a priority ticket<br>
                    ‚Ä¢ A specialist will respond within 30 minutes<br>
                    ‚Ä¢ You'll get a 20% discount on your next purchase<br><br>
                    Is there anything else I can help with while you wait?
                `;
                break;
        }
        output.innerHTML = response;
    }, 1500);
}

function generatePersonas() {
    const output = document.getElementById('persona-output');
    if (!output) return;

    output.innerHTML = '<div class="loading-spinner" style="margin:0 auto;"></div> Analyzing customer patterns...';

    setTimeout(() => {
        const personas = [
            { name: "The Busy Professional", traits: "High urgency, delivery-focused, churn risk 65%", icon: "üëî" },
            { name: "The Price-Conscious", traits: "Asks about discounts, compares prices, churn risk 45%", icon: "üí∞" },
            { name: "The Quality Seeker", traits: "Details-oriented, returns if not satisfied, churn risk 55%", icon: "‚≠ê" },
            { name: "The Loyal Advocate", traits: "Long-term customer, provides feedback, churn risk 15%", icon: "ü§ù" }
        ];

        output.innerHTML = personas.map(p => `
            <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:10px;">
                <div style="font-size:1.5rem; margin-bottom:5px;">${p.icon}</div>
                <strong>${p.name}</strong><br>
                <small>${p.traits}</small>
            </div>
        `).join('');
    }, 2000);
}

function saveTeamNote() {
    const note = document.getElementById('team-note');
    if (!note || !note.value.trim()) {
        alert('Please enter a note first');
        return;
    }

    const notes = JSON.parse(localStorage.getItem('teamNotes') || '[]');
    notes.push({
        text: note.value,
        date: new Date().toISOString(),
        author: 'Current User'
    });
    localStorage.setItem('teamNotes', JSON.stringify(notes));
    
    note.value = '';
    loadTeamNotes();
    showTemporaryMessage('Note saved successfully!');
}

function loadTeamNotes() {
    const notesList = document.getElementById('notes-list');
    if (!notesList) return;

    const notes = JSON.parse(localStorage.getItem('teamNotes') || '[]');
    
    if (notes.length === 0) {
        notesList.innerHTML = '<div style="text-align:center; color:#888;">No notes yet</div>';
        return;
    }

    notesList.innerHTML = notes.reverse().map(note => `
        <div style="background:#f8f9fa; padding:10px; border-radius:6px; margin-bottom:8px; font-size:0.9rem;">
            <strong>${new Date(note.date).toLocaleString()}</strong><br>
            ${note.text}
        </div>
    `).join('');
}

function toggleAlerts() {
    const toggle = document.getElementById('alert-toggle');
    const status = document.getElementById('alert-status');
    
    if (toggle.checked) {
        status.innerHTML = '‚úì Alerts are active';
        status.style.color = '#28a745';
        showTemporaryMessage('Real-time alerts enabled');
    } else {
        status.innerHTML = '‚úó Alerts are disabled';
        status.style.color = '#dc3545';
    }
}

// ===== EXPORT =====
function exportInsights() {
    if (customers.length === 0) {
        alert('No data to export');
        return;
    }

    let csv = 'Name,Email,Total Chats,Positive,Negative,Neutral,Churn Risk,Company,Job Title,Detected Problems\n';
    
    customers.forEach(c => {
        const chats = allChats[c.email] || [];
        const pos = chats.filter(m => (m.sentiment || '').toLowerCase() === 'positive').length;
        const neg = chats.filter(m => (m.sentiment || '').toLowerCase() === 'negative').length;
        const neu = chats.filter(m => (m.sentiment || '').toLowerCase() === 'neutral').length;
        const problems = [...new Set(chats.map(chat => chat.problem || detectProblem(chat.message || '')))].filter(p => p !== 'other').join(';');
        
        csv += `"${(c.name || 'Visitor').replace(/"/g,'""')}",`;
        csv += `"${(c.email || '').replace(/"/g,'""')}",`;
        csv += `${chats.length},${pos},${neg},${neu},`;
        csv += `${calculateRisk(chats)},`;
        csv += `"${(c.company || '').replace(/"/g,'""')}",`;
        csv += `"${(c.job_title || '').replace(/"/g,'""')}",`;
        csv += `"${problems}"\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `customer-insights-${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    
    showTemporaryMessage('Export completed!');
}

function exportProblemReport() {
    const data = [
        ['Problem Type', 'Frequency', 'Trend', 'Avg Resolution', 'Impact Score'],
        ['Delivery Issues', problemStats.delivery, '+12%', '2.5h', '85'],
        ['Product Quality', problemStats.quality, '+5%', '3.2h', '92'],
        ['Pricing Concerns', problemStats.pricing, '-3%', '1.8h', '45'],
        ['Support Requests', problemStats.support, '+8%', '4.1h', '78'],
        ['Refund Requests', problemStats.refund, '-2%', '2.0h', '95'],
        ['UX/Confusion', problemStats.ux, '+15%', '1.5h', '60']
    ];
    
    let csv = data.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `problem-analysis-${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    
    showTemporaryMessage('Problem report exported!');
}

// ===== LIVE UPDATES =====
function startLiveUpdates() {
    if (pollingInterval) clearInterval(pollingInterval);
    pollingInterval = setInterval(() => loadCustomers(true), 30000);
}

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', async () => {
    console.log("Initializing Customer Insights...");

    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = 'login.html';
        return;
    }

    // Initialize charts
    const sentimentEl = document.getElementById('sentiment-chart');
    const trendEl = document.getElementById('trend-chart');
    const timelineEl = document.getElementById('sentiment-timeline');

    if (sentimentEl) {
        sentimentChart = new Chart(sentimentEl, {
            type: 'doughnut',
            data: {
                labels: ['Positive', 'Negative', 'Neutral'],
                datasets: [{
                    data: [33, 33, 34],
                    backgroundColor: ['#28a745', '#dc3545', '#6b7280']
                }]
            },
            options: {
                responsive: true,
                cutout: '65%',
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    if (trendEl) {
        trendChart = new Chart(trendEl, {
            type: 'line',
            data: {
                labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                datasets: [{
                    label: 'Negative %',
                    data: [0, 0, 0, 0],
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220,53,69,0.1)',
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: { display: true }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    if (timelineEl) {
        sentimentTimeline = new Chart(timelineEl, {
            type: 'line',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'Sentiment Score',
                    data: [65, 59, 80, 81, 56, 55, 70],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59,130,246,0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    await loadCustomers();
    startLiveUpdates();
    loadTeamNotes();
    refreshKnowledgeSuggestions();
    
    // Email preview updates
    document.getElementById('email-subject').addEventListener('input', updateEmailPreview);
    document.getElementById('email-content').addEventListener('input', updateEmailPreview);
    
    const alertToggle = document.getElementById('alert-toggle');
    if (alertToggle) {
        alertToggle.checked = true;
    }
});

window.addEventListener('beforeunload', () => {
    if (pollingInterval) {
        clearInterval(pollingInterval);
    }
});
</script>
</body>
</html>