<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Settings - AI Automation Powerhouse</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #d4af37;
            --primary-light: #f5e7b2;
            --primary-dark: #b8962e;
            --primary-gradient: linear-gradient(135deg, #d4af37 0%, #f1c40f 100%);
            --dark: #0f172a;
            --dark-accent: #1e293b;
            --light: #ffffff;
            --light-gray: #f8fafc;
            --medium-gray: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --success: #059669;
            --success-light: #d1fae5;
            --danger: #dc2626;
            --danger-light: #fee2e2;
            --warning: #d97706;
            --warning-light: #fef3c7;
            --info: #2563eb;
            --info-light: #dbeafe;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
            --card-radius: 16px;
            --button-radius: 8px;
            --transition: all 0.2s ease;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: #f1f5f9;
            color: var(--text-primary); 
            line-height: 1.5; 
        }

        nav {
            background: white;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav-container { 
            max-width: 1400px; 
            margin: 0 auto; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px 32px; 
        }
        
        .nav-logo { 
            font-weight: 800; 
            font-size: 1.4rem; 
            color: var(--primary-dark);
            text-decoration: none; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        
        .nav-links { 
            display: flex; 
            gap: 24px; 
            align-items: center; 
        }
        
        .nav-links a { 
            text-decoration: none; 
            color: var(--text-secondary); 
            font-size: 0.95rem; 
            font-weight: 500; 
            transition: var(--transition); 
            padding: 6px 0;
        }
        
        .nav-links a:hover { 
            color: var(--primary-dark); 
        }
        
        .nav-links a.active { 
            color: var(--primary-dark); 
            font-weight: 600;
            border-bottom: 2px solid var(--primary);
        }
        
        .back-btn { 
            background: var(--dark); 
            color: white !important; 
            padding: 8px 20px !important; 
            border-radius: 40px; 
            font-weight: 500 !important;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 24px 32px;
        }

        .page-header {
            margin-bottom: 32px;
        }
        
        .page-header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .page-header p {
            color: var(--text-muted);
            margin-top: 8px;
        }

        .settings-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 32px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 16px;
        }
        
        .settings-tab {
            padding: 10px 24px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }
        
        .settings-tab:hover {
            color: var(--primary-dark);
            background: var(--light-gray);
        }
        
        .settings-tab.active {
            background: var(--primary-gradient);
            color: white;
        }

        .settings-card {
            background: white;
            border-radius: var(--card-radius);
            border: 1px solid var(--border-color);
            padding: 32px;
            margin-bottom: 24px;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .settings-header h2 {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 24px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .form-group input, 
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
            font-family: inherit;
        }
        
        .form-group input:focus, 
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .input-group {
            display: flex;
            gap: 12px;
        }
        
        .input-group input {
            flex: 1;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: white;
            color: var(--text-primary);
            border: 2px solid var(--border-color);
            padding: 12px 28px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .btn-secondary:hover {
            border-color: var(--primary);
        }

        .api-key-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--light-gray);
            border-radius: 8px;
            margin-bottom: 12px;
        }
        
        .api-key-info h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .api-key-info p {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-family: monospace;
        }
        
        .api-key-actions {
            display: flex;
            gap: 8px;
        }
        
        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: white;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .icon-btn:hover {
            background: var(--light-gray);
            border-color: var(--primary);
        }

        .danger-zone {
            border: 2px solid var(--danger);
            background: var(--danger-light);
        }

        .danger-zone .btn-danger {
            background: var(--danger);
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .danger-zone .btn-danger:hover {
            background: #b91c1c;
        }

        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: white;
            border-radius: 8px;
            padding: 12px 20px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
            z-index: 1000;
            font-size: 0.9rem;
            max-width: 350px;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(212,175,55,0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden { display: none; }
    </style>
</head>
<body>

<nav>
    <div class="nav-container">
        <a href="dashboard.html" class="nav-logo">
            <i class="fas fa-cog" style="color: var(--primary);"></i>
            AI Powerhouse
        </a>
        <div class="nav-links">
            <a href="dashboard.html">Dashboard</a>
            <a href="ai-powerhouse.html">Automations</a>
            <a href="analytics.html">Analytics</a>
            <a href="#" class="active">Settings</a>
            <a href="ai-automations.html" class="back-btn">
                <i class="fas fa-arrow-left"></i> Back
            </a>
        </div>
    </div>
</nav>

<div class="container">
    <div class="page-header">
        <h1>Settings</h1>
        <p>Manage your account, API keys, and preferences</p>
    </div>

    <div class="settings-tabs">
        <span class="settings-tab active" onclick="switchTab('profile')">Profile</span>
        <span class="settings-tab" onclick="switchTab('security')">Security</span>
        <span class="settings-tab" onclick="switchTab('api')">API Keys</span>
        <span class="settings-tab" onclick="switchTab('notifications')">Notifications</span>
        <span class="settings-tab" onclick="switchTab('billing')">Billing</span>
    </div>

    <!-- Profile Tab -->
    <div id="profile-tab" class="settings-card">
        <div class="settings-header">
            <h2>Profile Information</h2>
        </div>
        
        <div class="form-group">
            <label>Business Name</label>
            <input type="text" id="businessName" placeholder="Your business name">
        </div>
        
        <div class="form-group">
            <label>Display Name</label>
            <input type="text" id="displayName" placeholder="Your name">
        </div>
        
        <div class="form-group">
            <label>Email</label>
            <input type="email" id="email" disabled style="background: var(--light-gray);">
        </div>
        
        <div class="form-group">
            <label>Plan</label>
            <input type="text" id="plan" disabled style="background: var(--light-gray);">
        </div>
        
        <div class="form-group">
            <label>Widget Color</label>
            <input type="color" id="widgetColor" value="#d4af37">
        </div>
        
        <div class="form-group">
            <label>Welcome Message</label>
            <input type="text" id="welcomeMessage" placeholder="Welcome message for widget">
        </div>
        
        <button class="btn-primary" onclick="saveProfile()">Save Changes</button>
    </div>

    <!-- Security Tab (hidden by default) -->
    <div id="security-tab" class="settings-card hidden">
        <div class="settings-header">
            <h2>Security Settings</h2>
        </div>
        
        <div class="form-group">
            <label>Current Password</label>
            <input type="password" id="currentPassword" placeholder="Enter current password">
        </div>
        
        <div class="form-group">
            <label>New Password</label>
            <input type="password" id="newPassword" placeholder="Enter new password (min 6 characters)">
        </div>
        
        <div class="form-group">
            <label>Confirm New Password</label>
            <input type="password" id="confirmPassword" placeholder="Confirm new password">
        </div>
        
        <button class="btn-primary" onclick="changePassword()">Change Password</button>
        
        <hr style="margin: 32px 0;">
        
        <div class="danger-zone" style="padding: 24px; border-radius: 8px;">
            <h3 style="color: var(--danger); margin-bottom: 16px;">Danger Zone</h3>
            <p style="margin-bottom: 16px;">Once you delete your account, there is no going back. All your data will be permanently removed.</p>
            <button class="btn-danger" onclick="deleteAccount()">Delete Account</button>
        </div>
    </div>

    <!-- API Keys Tab (hidden by default) -->
    <div id="api-tab" class="settings-card hidden">
        <div class="settings-header">
            <h2>API Keys</h2>
            <button class="btn-primary" onclick="showCreateApiKeyModal()">+ New Key</button>
        </div>
        
        <div id="apiKeysList">
            <div style="text-align: center; padding: 40px;">
                <div class="loading-spinner"></div>
                <p style="margin-top: 16px; color: var(--text-muted);">Loading API keys...</p>
            </div>
        </div>
    </div>

    <!-- Notifications Tab (hidden by default) -->
    <div id="notifications-tab" class="settings-card hidden">
        <div class="settings-header">
            <h2>Notification Preferences</h2>
        </div>
        
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 12px;">
                <input type="checkbox" id="emailNotifications" checked>
                Email Notifications
            </label>
            <p style="color: var(--text-muted); font-size: 0.9rem; margin-left: 28px;">Receive email alerts for automation events</p>
        </div>
        
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 12px;">
                <input type="checkbox" id="notifySuccess" checked>
                Notify on Success
            </label>
        </div>
        
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 12px;">
                <input type="checkbox" id="notifyFailure" checked>
                Notify on Failure
            </label>
        </div>
        
        <div class="form-group">
            <label>Slack Webhook (optional)</label>
            <input type="url" id="slackWebhook" placeholder="https://hooks.slack.com/services/...">
        </div>
        
        <div class="form-group">
            <label>Discord Webhook (optional)</label>
            <input type="url" id="discordWebhook" placeholder="https://discord.com/api/webhooks/...">
        </div>
        
        <button class="btn-primary" onclick="saveNotifications()">Save Preferences</button>
    </div>

    <!-- Billing Tab (hidden by default) -->
    <div id="billing-tab" class="settings-card hidden">
        <div class="settings-header">
            <h2>Billing Information</h2>
        </div>
        
        <div class="form-group">
            <label>Current Plan</label>
            <div style="display: flex; align-items: center; gap: 16px;">
                <span id="currentPlan" style="font-weight: 600;">Free</span>
                <button class="btn-primary" onclick="upgradePlan()">Upgrade</button>
            </div>
        </div>
        
        <div class="form-group">
            <label>Plan Expires</label>
            <span id="planExpires">Never</span>
        </div>
        
        <div class="form-group">
            <label>Usage This Month</label>
            <div id="usageStats">
                <div style="margin-bottom: 8px;">
                    <span>Messages: </span><span id="messagesUsed">0</span>/<span id="messagesLimit">50</span>
                </div>
                <div class="progress-bar" style="height: 8px; background: var(--medium-gray); border-radius: 4px; margin-bottom: 12px;">
                    <div id="messagesProgress" class="progress-fill" style="width: 0%; height: 100%; background: var(--primary-gradient); border-radius: 4px;"></div>
                </div>
                
                <div style="margin-bottom: 8px;">
                    <span>Leads: </span><span id="leadsUsed">0</span>/<span id="leadsLimit">10</span>
                </div>
                <div class="progress-bar" style="height: 8px; background: var(--medium-gray); border-radius: 4px;">
                    <div id="leadsProgress" class="progress-fill" style="width: 0%; height: 100%; background: var(--primary-gradient); border-radius: 4px;"></div>
                </div>
            </div>
        </div>
        
        <div class="settings-header" style="margin-top: 32px;">
            <h3>Payment History</h3>
        </div>
        
        <div id="paymentHistory">
            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                No payment history yet
            </div>
        </div>
    </div>
</div>

<!-- Create API Key Modal -->
<div class="modal" id="apiKeyModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000;">
    <div style="background: white; border-radius: 16px; padding: 32px; max-width: 400px; width: 90%;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h3 style="font-size: 1.3rem; font-weight: 600;">Create API Key</h3>
            <button onclick="closeApiKeyModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
        </div>
        
        <div class="form-group">
            <label>Key Name</label>
            <input type="text" id="keyName" placeholder="e.g., Production Key">
        </div>
        
        <div class="form-group">
            <label>Platform</label>
            <select id="keyPlatform">
                <option value="general">General</option>
                <option value="tiktok">TikTok</option>
                <option value="instagram">Instagram</option>
                <option value="youtube">YouTube</option>
                <option value="shopify">Shopify</option>
                <option value="stripe">Stripe</option>
            </select>
        </div>
        
        <div style="display: flex; gap: 12px; margin-top: 24px;">
            <button class="btn-secondary" onclick="closeApiKeyModal()" style="flex: 1;">Cancel</button>
            <button class="btn-primary" onclick="createApiKey()" style="flex: 1;">Create Key</button>
        </div>
    </div>
</div>

<script>
const BACKEND_URL = window.BACKEND_URL || 'https://ai-smart-hub.onrender.com';
const API_BASE = `${BACKEND_URL}/api`;

// Initialize on load
document.addEventListener('DOMContentLoaded', async () => {
    await checkAuth();
    await loadProfile();
    await loadApiKeys();
    await loadBillingInfo();
    await loadNotificationSettings();
});

// Check authentication
async function checkAuth() {
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = 'login.html';
        return false;
    }
    return true;
}

// Tab switching
function switchTab(tabName) {
    document.querySelectorAll('.settings-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');
    
    document.querySelectorAll('[id$="-tab"]').forEach(tab => {
        tab.classList.add('hidden');
    });
    
    document.getElementById(`${tabName}-tab`).classList.remove('hidden');
}

// Load profile data
async function loadProfile() {
    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE}/settings/profile`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) throw new Error('Failed to load profile');
        
        const data = await response.json();
        
        document.getElementById('businessName').value = data.business_name || '';
        document.getElementById('displayName').value = data.name || '';
        document.getElementById('email').value = data.email || '';
        document.getElementById('plan').value = (data.plan || 'free').toUpperCase();
        document.getElementById('widgetColor').value = data.widget_color || '#d4af37';
        document.getElementById('welcomeMessage').value = data.welcome_message || '';
        
    } catch (error) {
        console.error('Error loading profile:', error);
        showToast('Failed to load profile', 'error');
    }
}

// Save profile
async function saveProfile() {
    const data = {
        business_name: document.getElementById('businessName').value,
        name: document.getElementById('displayName').value,
        widget_color: document.getElementById('widgetColor').value,
        welcome_message: document.getElementById('welcomeMessage').value
    };
    
    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE}/settings/profile`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(data)
        });
        
        if (!response.ok) throw new Error('Failed to save profile');
        
        showToast('Profile updated successfully', 'success');
        
    } catch (error) {
        console.error('Error saving profile:', error);
        showToast('Failed to save profile', 'error');
    }
}

// Change password
async function changePassword() {
    const current = document.getElementById('currentPassword').value;
    const newPass = document.getElementById('newPassword').value;
    const confirm = document.getElementById('confirmPassword').value;
    
    if (!current || !newPass || !confirm) {
        showToast('Please fill all fields', 'error');
        return;
    }
    
    if (newPass.length < 6) {
        showToast('Password must be at least 6 characters', 'error');
        return;
    }
    
    if (newPass !== confirm) {
        showToast('Passwords do not match', 'error');
        return;
    }
    
    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE}/settings/change-password`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ current_password: current, new_password: newPass })
        });
        
        if (!response.ok) {
            const data = await response.json();
            throw new Error(data.error || 'Failed to change password');
        }
        
        showToast('Password changed successfully', 'success');
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
        
    } catch (error) {
        console.error('Error changing password:', error);
        showToast(error.message, 'error');
    }
}

// Load API keys
async function loadApiKeys() {
    const container = document.getElementById('apiKeysList');
    
    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE}/settings/api-keys`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) throw new Error('Failed to load API keys');
        
        const keys = await response.json();
        
        if (keys.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No API keys yet. Create your first key.</div>';
            return;
        }
        
        container.innerHTML = keys.map(key => `
            <div class="api-key-item">
                <div class="api-key-info">
                    <h4>${key.name}</h4>
                    <p>${key.platform} • Created: ${new Date(key.created_at).toLocaleDateString()}</p>
                </div>
                <div class="api-key-actions">
                    <button class="icon-btn" onclick="copyApiKey('${key.api_key}')" title="Copy">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button class="icon-btn" onclick="deleteApiKey('${key.id}')" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Error loading API keys:', error);
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--danger);">Failed to load API keys</div>';
    }
}

// Show create API key modal
function showCreateApiKeyModal() {
    document.getElementById('apiKeyModal').style.display = 'flex';
}

function closeApiKeyModal() {
    document.getElementById('apiKeyModal').style.display = 'none';
    document.getElementById('keyName').value = '';
    document.getElementById('keyPlatform').value = 'general';
}

// Create API key
async function createApiKey() {
    const name = document.getElementById('keyName').value;
    const platform = document.getElementById('keyPlatform').value;
    
    if (!name) {
        showToast('Please enter a key name', 'error');
        return;
    }
    
    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE}/settings/api-keys`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ name, platform })
        });
        
        if (!response.ok) throw new Error('Failed to create API key');
        
        const data = await response.json();
        
        showToast(`API Key created: ${data.api_key}`, 'success');
        closeApiKeyModal();
        await loadApiKeys();
        
    } catch (error) {
        console.error('Error creating API key:', error);
        showToast('Failed to create API key', 'error');
    }
}

// Delete API key
async function deleteApiKey(id) {
    if (!confirm('Are you sure you want to delete this API key? This action cannot be undone.')) return;
    
    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE}/settings/api-keys/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) throw new Error('Failed to delete API key');
        
        showToast('API key deleted', 'success');
        await loadApiKeys();
        
    } catch (error) {
        console.error('Error deleting API key:', error);
        showToast('Failed to delete API key', 'error');
    }
}

// Copy API key to clipboard
function copyApiKey(key) {
    navigator.clipboard.writeText(key);
    showToast('API key copied to clipboard', 'success');
}

// Load billing information
async function loadBillingInfo() {
    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE}/settings/billing`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) throw new Error('Failed to load billing info');
        
        const data = await response.json();
        
        document.getElementById('currentPlan').textContent = data.current_plan || 'Free';
        document.getElementById('planExpires').textContent = data.plan_expires ? new Date(data.plan_expires).toLocaleDateString() : 'Never';
        
        document.getElementById('messagesUsed').textContent = data.usage?.messages || 0;
        document.getElementById('messagesLimit').textContent = data.usage?.messages_limit || 50;
        document.getElementById('leadsUsed').textContent = data.usage?.leads || 0;
        document.getElementById('leadsLimit').textContent = data.usage?.leads_limit || 10;
        
        const messagesPercent = (data.usage?.messages / data.usage?.messages_limit) * 100;
        const leadsPercent = (data.usage?.leads / data.usage?.leads_limit) * 100;
        
        document.getElementById('messagesProgress').style.width = `${Math.min(messagesPercent, 100)}%`;
        document.getElementById('leadsProgress').style.width = `${Math.min(leadsPercent, 100)}%`;
        
    } catch (error) {
        console.error('Error loading billing info:', error);
    }
}

// Load notification settings
async function loadNotificationSettings() {
    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE}/settings/notifications`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) throw new Error('Failed to load notification settings');
        
        const data = await response.json();
        
        document.getElementById('emailNotifications').checked = data.email_notifications !== false;
        document.getElementById('notifySuccess').checked = data.notify_on_success !== false;
        document.getElementById('notifyFailure').checked = data.notify_on_failure !== false;
        document.getElementById('slackWebhook').value = data.slack_webhook || '';
        document.getElementById('discordWebhook').value = data.discord_webhook || '';
        
    } catch (error) {
        console.error('Error loading notification settings:', error);
    }
}

// Save notification settings
async function saveNotifications() {
    const data = {
        email_notifications: document.getElementById('emailNotifications').checked,
        notify_on_success: document.getElementById('notifySuccess').checked,
        notify_on_failure: document.getElementById('notifyFailure').checked,
        slack_webhook: document.getElementById('slackWebhook').value,
        discord_webhook: document.getElementById('discordWebhook').value
    };
    
    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE}/settings/notifications`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(data)
        });
        
        if (!response.ok) throw new Error('Failed to save notification settings');
        
        showToast('Notification settings saved', 'success');
        
    } catch (error) {
        console.error('Error saving notification settings:', error);
        showToast('Failed to save notification settings', 'error');
    }
}

// Upgrade plan
function upgradePlan() {
    window.location.href = 'pricing.html';
}

// Delete account
async function deleteAccount() {
    if (!confirm('⚠️ WARNING: This will permanently delete your account and all data. Are you absolutely sure?')) return;
    
    const confirmText = prompt('Type "DELETE" to confirm:');
    if (confirmText !== 'DELETE') {
        showToast('Account deletion cancelled', 'info');
        return;
    }
    
    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE}/admin/users/delete-account`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) throw new Error('Failed to delete account');
        
        localStorage.removeItem('token');
        showToast('Account deleted successfully', 'success');
        setTimeout(() => window.location.href = 'login.html', 2000);
        
    } catch (error) {
        console.error('Error deleting account:', error);
        showToast('Failed to delete account', 'error');
    }
}

// Toast notification
function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.style.background = type === 'success' ? '#059669' : '#dc2626';
    toast.style.color = 'white';
    toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i> ${message}`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}
</script>
</body>
</html>