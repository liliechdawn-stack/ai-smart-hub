<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard - AI Platform</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* ================= GLOBAL ================= */
    body, html { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: #f9f9f9; }
    .dashboard { display: none; flex-direction: row; }
    nav a { display: block; padding: 10px 0; cursor: pointer; color: #333; text-decoration: none; }
    nav a.active { font-weight: bold; color: #d4af37; }

    #adminBtn {
      margin-top: 16px;
      background-color: #FFD700;
      color: #000;
      border: none;
      padding: 10px;
      cursor: pointer;
      width: 100%;
      font-weight: bold;
    }

    /* ================= SIDEBAR ================= */
    .sidebar {
      width: 220px;
      background: #fff;
      border-right: 1px solid #ddd;
      padding: 20px;
      box-sizing: border-box;
      height: 100vh;
    }

    .sidebar h2 { margin-top: 0; }

    /* ================= MAIN ================= */
    .main {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }

    section { margin-bottom: 30px; }

    input, textarea, button { font-family: 'Inter', sans-serif; margin-bottom: 10px; }

    textarea { resize: none; width: 100%; }

    /* ================= CHAT ================= */
    .chat-interface {
      max-height: 420px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      background: #fafafa;
      border-radius: 8px;
    }

    #chatResponses {
      max-height: 260px;
      overflow-y: auto;
      padding-right: 8px;
      margin-top: 10px;
    }

    .chat-bubble {
      margin-bottom: 12px;
      padding: 10px;
      border-radius: 8px;
      background: #fff;
      word-wrap: break-word;
      white-space: pre-wrap;
      line-height: 1.4;
      border: 1px solid #eee;
    }

    .chat-bubble strong { color: #444; }

    #chatTable, #leadsTable {
      width: 100%;
      border-collapse: collapse;
    }

    #chatTable td, #chatTable th, #leadsTable td, #leadsTable th {
      border: 1px solid #ddd;
      padding: 8px;
      vertical-align: top;
    }

    /* ================= ANALYTICS ================= */
    .analytics {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    .analytics .card {
      flex: 1;
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      text-align: center;
    }

    .hidden { display: none; }

    /* ================= CHART ================= */
    #riseFallChart {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
  </style>
</head>

<body>

<div class="dashboard">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <h2>AI Platform</h2>
    <nav>
      <a id="navAnalytics" class="active">Analytics</a>
      <a id="navLeads">Leads</a>
      <a id="navChats">Chats</a>
      <a id="navSettings">Settings</a>
      <a id="navWidget">AI Widget</a>
    </nav>

    <p style="margin-top:20px;">Business: <span id="businessName">Business</span></p>
    <p>Plan: <span id="currentPlan">free</span></p>
    <p>Messages Left: <span id="messagesUsed">0</span></p>
    <p>Leads Left: <span id="leadsUsed">0</span></p>

    <button id="logoutBtn">Logout</button>
    <button id="adminBtn" class="hidden">Admin Panel</button>
  </aside>

  <!-- MAIN -->
  <main class="main">

    <!-- ================= ANALYTICS ================= -->
    <section id="analyticsSection">
      <h2>Business Overview</h2>
      <div class="analytics">
        <div class="card">
          <h3 id="totalChats">0</h3>
          <p>Total Chats</p>
        </div>
        <div class="card">
          <h3 id="totalLeads">0</h3>
          <p>Total Leads</p>
        </div>
        <div class="card">
          <h3 id="messagesRemaining">0</h3>
          <p>Messages Left</p>
        </div>
        <div class="card">
          <h3 id="leadsRemaining">0</h3>
          <p>Leads Left</p>
        </div>
      </div>
      <h3>Rise & Fall of Business</h3>
      <canvas id="riseFallChart" height="200"></canvas>
    </section>

    <!-- ================= LEADS ================= -->
    <section id="leadsSection" class="hidden">
      <h2>Leads</h2>
      <div class="add-lead">
        <input id="leadName" placeholder="Name" />
        <input id="leadEmail" placeholder="Email" />
        <input id="leadPhone" placeholder="Phone (optional)" />
        <button id="addLeadBtn">Add Lead</button>
      </div>
      <h3>Lead List</h3>
      <table id="leadsTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Date Added</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- ================= CHATS ================= -->
    <section id="chatSection" class="hidden">
      <h2>Chat History</h2>
      <table id="chatTable">
        <thead>
          <tr>
            <th>Client</th>
            <th>Message</th>
            <th>Response</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="chat-interface">
        <h3>AI Chat</h3>
        <input id="clientName" placeholder="Client Name" />
        <textarea id="aiMessage" placeholder="Type your message..." rows="3"></textarea>
        <button id="sendBtn">Send</button>
        <div id="chatResponses"></div>
      </div>
    </section>

    <!-- ================= SETTINGS ================= -->
    <section id="settingsSection" class="hidden">
      <h2>Settings</h2>
      <p>Manage your subscription and profile here.</p>
      <div id="planCards"></div>
    </section>

    <!-- ================= AI WIDGET ================= -->
    <section id="widgetSection" class="hidden">
      <h2>AI Widget</h2>
      <p>Configure your AI widget here.</p>
    </section>

  </main>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const API = "http://localhost:5000/api";
  const token = localStorage.getItem("token");
  const email = localStorage.getItem("email");

  if (!token) {
    alert("Login required");
    location.href = "login.html";
    return;
  }

  document.querySelector(".dashboard").style.display = "flex";

  const sections = {
    analytics: document.getElementById("analyticsSection"),
    leads: document.getElementById("leadsSection"),
    chats: document.getElementById("chatSection"),
    settings: document.getElementById("settingsSection"),
    widget: document.getElementById("widgetSection")
  };

  const navLinks = {
    navAnalytics: sections.analytics,
    navLeads: sections.leads,
    navChats: sections.chats,
    navSettings: sections.settings,
    navWidget: sections.widget
  };

  Object.keys(navLinks).forEach(id => {
    document.getElementById(id).onclick = () => {
      Object.values(sections).forEach(s => s.classList.add("hidden"));
      Object.keys(navLinks).forEach(k => document.getElementById(k).classList.remove("active"));
      navLinks[id].classList.remove("hidden");
      document.getElementById(id).classList.add("active");
    };
  });

  const chatTable = document.getElementById("chatTable").querySelector("tbody");
  const chatResponses = document.getElementById("chatResponses");
  const leadsTable = document.getElementById("leadsTable").querySelector("tbody");

  async function loadDashboard() {
    const res = await fetch(`${API}/dashboard/full`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    const data = await res.json();

    document.getElementById("currentPlan").textContent = data.plan;
    document.getElementById("businessName").textContent = data.name;

    document.getElementById("totalChats").textContent = data.chats.length;
    document.getElementById("totalLeads").textContent = data.leads.length;
    document.getElementById("messagesRemaining").textContent = Math.max(0, data.messages_limit - data.messages_used);
    document.getElementById("leadsRemaining").textContent = Math.max(0, data.leads_limit - data.leads_used);

    if (email === "ericchung992@gmail.com") {
      document.getElementById("adminBtn").classList.remove("hidden");
      document.getElementById("adminBtn").onclick = () => location.href = "admin.html";
    }

    renderChats(data.chats);
    renderLeads(data.leads);
    renderRiseFallChart(data.riseFall || []);
  }

  function renderChats(chats) {
    chatTable.innerHTML = "";
    chatResponses.innerHTML = "";

    chats.forEach(c => {
      chatTable.innerHTML += `
        <tr>
          <td>${c.client_name}</td>
          <td>${c.message}</td>
          <td>${c.response}</td>
          <td>${new Date(c.created_at).toLocaleString()}</td>
        </tr>
      `;
      const div = document.createElement("div");
      div.className = "chat-bubble";
      div.innerHTML = `<strong>${c.client_name}:</strong><div>${c.message}</div><strong>AI:</strong><div>${c.response}</div>`;
      chatResponses.prepend(div);
    });
  }

  function renderLeads(leads) {
    leadsTable.innerHTML = "";
    leads.forEach(l => {
      leadsTable.innerHTML += `
        <tr>
          <td>${l.name}</td>
          <td>${l.email}</td>
          <td>${l.phone || "-"}</td>
          <td>${new Date(l.created_at).toLocaleString()}</td>
        </tr>
      `;
    });
  }

  // Render Rise & Fall Chart
  let riseFallChart;
  function renderRiseFallChart(dataPoints) {
    const ctx = document.getElementById("riseFallChart").getContext("2d");
    const labels = dataPoints.map(d => new Date(d.date).toLocaleDateString());
    const values = dataPoints.map(d => d.value);

    if (riseFallChart) riseFallChart.destroy();

    riseFallChart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "Business Rise & Fall",
          data: values,
          borderColor: "#d4af37",
          backgroundColor: "rgba(212,175,55,0.2)",
          fill: true,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true },
          x: { ticks: { maxRotation: 45, minRotation: 0 } }
        }
      }
    });
  }

  document.getElementById("sendBtn").onclick = async () => {
    const msg = aiMessage.value.trim();
    const name = clientName.value.trim();
    if (!msg || !name) return alert("Fill all fields");

    const res = await fetch(`${API}/widget/chat`, {
      method: "POST",
      headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
      body: JSON.stringify({ message: msg, client_name: name })
    });

    const data = await res.json();
    if (data.error) return alert(data.error);

    aiMessage.value = "";
    clientName.value = "";
    loadDashboard();
  };

  document.getElementById("addLeadBtn").onclick = async () => {
    const name = leadName.value.trim();
    const emailVal = leadEmail.value.trim();
    const phone = leadPhone.value.trim();
    if (!name || !emailVal) return alert("Name & email required");

    const res = await fetch(`${API}/leads`, {
      method: "POST",
      headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
      body: JSON.stringify({ name, email: emailVal, phone })
    });

    const data = await res.json();
    if (data.forceUpgrade) return alert(data.message);
    if (!data.success) return alert("Failed to add lead");

    alert("âœ… Lead added successfully");
    leadName.value = leadEmail.value = leadPhone.value = "";
    loadDashboard();
  };

  document.getElementById("logoutBtn").onclick = () => {
    localStorage.clear();
    location.href = "login.html";
  };

  loadDashboard();
});
</script>

</body>
</html>